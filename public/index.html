<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produção (Online)</title>
    
    <!-- SDKs do Firebase -->
    <script type="module">
        // Importa os módulos necessários
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, 
            signInWithEmailAndPassword, signOut, onAuthStateChanged,
            createUserWithEmailAndPassword // NOVO: Para registo
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, onSnapshot, 
            deleteDoc, query, where, writeBatch, setLogLevel,
            getDoc, setDoc // NOVO: Para definir a função
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ***************************************************************
        // CONFIGURAÇÃO MANUAL DO FIREBASE
        // (O seu NOVO bloco de configuração está colado aqui)
        // ***************************************************************
        
        // Your web app's Firebase configuration
        const firebaseConfig = {

  apiKey: "AIzaSyA8dGdSRGDtgNVgnI5vmpxsIKdjkhWAnTo",

  authDomain: "numartestefinal.firebaseapp.com",

  projectId: "numartestefinal",

  storageBucket: "numartestefinal.firebasestorage.app",

  messagingSenderId: "97213975077",

  appId: "1:97213975077:web:f917ed086a26d378f90dcc"

};
        
        // ***************************************************************
        // FIM DA CONFIGURAÇÃO MANUAL
        // ***************************************************************


        // --- VARIÁVEIS GLOBAIS ---
        let app, auth, db;
        let userId;
        let userRole = null; 
        
        let listeners = [];
        
        // Usa o AppID da configuração manual
        const appId = firebaseConfig.appId;

        // Caches locais
        let itensDB = [];
        let producaoDB = [];
        let contagemDB = [];
        let fichasDB = [];
        let vendasDB = [];
        
        // Referências das Coleções do Firestore
        let itensCol, producaoCol, contagemCol, fichasCol, vendasCol, userRolesCol;
        
        let relatorioCache = []; 

        // --- ELEMENTOS DO DOM (Constantes) ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        
        // Formulário de Login
        const loginForm = document.getElementById('login-form');
        const loginName = document.getElementById('login-name');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const showRegisterLink = document.getElementById('show-register-link');
        
        // NOVO: Formulário de Registo
        const registerContainer = document.getElementById('register-container');
        const registerForm = document.getElementById('register-form');
        const registerNomeCompleto = document.getElementById('register-nome-completo');
        const registerNomeLogin = document.getElementById('register-nome-login');
        const registerPassword = document.getElementById('register-password');
        const registerFuncao = document.getElementById('register-funcao');
        const registerError = document.getElementById('register-error');
        const showLoginLink = document.getElementById('show-login-link');
        
        // Elementos do App
        const logoutButton = document.getElementById('logout-button');
        const userNameDisplay = document.getElementById('user-name-display');
        const formItens = document.getElementById('form-itens');
        const listaItens = document.getElementById('lista-itens');
        const itemNome = document.getElementById('item-nome');
        const itemCategoria = document.getElementById('item-categoria');
        const formProducao = document.getElementById('form-producao');
        const listaProducao = document.getElementById('lista-producao');
        const prodData = document.getElementById('prod-data');
        const prodColaborador = document.getElementById('prod-colaborador');
        const prodProteina = document.getElementById('prod-proteina');
        const prodPeso = document.getElementById('prod-peso');
        const prodPorcao = document.getElementById('prod-porcao');
        const prodNumPorcoes = document.getElementById('prod-num-porcoes');
        const resumoProducao = document.getElementById('resumo-producao');
        const formContagem = document.getElementById('form-contagem');
        const listaContagem = document.getElementById('lista-contagem');
        const contData = document.getElementById('cont-data');
        const contLocal = document.getElementById('cont-local');
        const contProteina = document.getElementById('cont-proteina');
        const contUnidade = document.getElementById('cont-unidade');
        const contQuantidade = document.getElementById('cont-quantidade');
        const copiarContagemBtn = document.getElementById('copiar-contagem-btn');
        const contFiltroDataInicio = document.getElementById('cont-filtro-data-inicio');
        const contFiltroDataFim = document.getElementById('cont-filtro-data-fim');
        const contFiltroBtn = document.getElementById('cont-filtro-btn');
        const formFicha = document.getElementById('form-ficha'); 
        const listaFichas = document.getElementById('lista-fichas'); 
        const fichaNomePrato = document.getElementById('ficha-nome-prato');
        const fichaTipoPrato = document.getElementById('ficha-tipo-prato');
        const addIngredienteBtn = document.getElementById('add-ingrediente-btn');
        const ingredientesContainer = document.getElementById('ingredientes-container');
        const formVenda = document.getElementById('form-venda');
        const listaVendas = document.getElementById('lista-vendas');
        const vendaData = document.getElementById('venda-data');
        const vendaPratoSelect = document.getElementById('venda-prato');
        const vendaQuantidade = document.getElementById('venda-quantidade');
        const filtroDataInicio = document.getElementById('filtro-data-inicio');
        const filtroDataFim = document.getElementById('filtro-data-fim');
        const filtroRelatorioBtn = document.getElementById('filtro-relatorio-btn');
        const listaRelatorio = document.getElementById('lista-relatorio');

        // --- ESTILO CSS ---
        const style = document.createElement('style');
        style.textContent = `
            /* Estilo geral */
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f4f7f6;
                color: #333;
            }
            header {
                background-color: #2c3e50; /* Azul escuro */
                color: white;
                padding: 1rem 1.5rem; /* Reduzido padding */
                display: flex; /* Flexbox */
                justify-content: space-between; /* Alinha itens */
                align-items: center; /* Centraliza verticalmente */
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            header h1 { 
                margin: 0; 
                font-size: 1.25rem; /* Reduzido tamanho */
                text-align: left;
            }
            /* NOVO: Header Info (Usuário e Logout) */
            .header-info {
                display: flex;
                align-items: center;
                font-size: 0.9rem;
            }
            #user-name-display {
                margin-right: 15px;
                font-weight: 500;
            }
            #logout-button {
                background-color: #e74c3c;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            #logout-button:hover {
                background-color: #c0392b;
            }

            main {
                padding: 1rem;
                max-width: 900px;
                margin: 0 auto;
            }
            
            /* NOVO: Telas de Login/Registo */
            .auth-container {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                background-color: #f4f7f6;
            }
            .auth-form {
                background: white;
                padding: 2.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                width: 100%;
                max-width: 400px;
            }
            .auth-form h2 {
                text-align: center;
                margin-top: 0;
                color: #2c3e50;
            }
            .auth-form .form-group { margin-bottom: 1.25rem; }
            .auth-form label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
            }
            .auth-form input, .auth-form select {
                width: 100%;
                padding: 12px;
                border: 1px solid #ccc;
                border-radius: 6px;
                box-sizing: border-box; /* Garante padding correto */
            }
            .auth-form button {
                width: 100%;
                padding: 12px;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 1.1em;
                font-weight: 600;
                cursor: pointer;
            }
            .auth-form .auth-link {
                text-align: center;
                margin-top: 1.5rem;
                font-size: 0.9em;
                color: #3498db;
                cursor: pointer;
            }
            .auth-form .auth-link:hover {
                text-decoration: underline;
            }
            .auth-error {
                color: #e74c3c;
                text-align: center;
                margin-top: 1rem;
                display: none; /* Oculto por padrão */
            }
            
            /* NOVO: Controle de Visibilidade */
            #app-container, #register-container {
                display: none; /* App e Registo ocultos por padrão */
            }
            .tab-hidden {
                display: none !important; /* Força esconder a aba */
            }
            /* Oculta botões de delete por padrão */
            .action-button {
                display: none;
            }
            /* Acesso de Proprietário: Mostra botões de delete */
            body.role-Proprietário .action-button {
                display: inline-block;
                background-color: #e74c3c;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }
            body.role-Proprietário .action-button:hover {
                background-color: #c0392b;
            }

            /* Abas */
            .tab-nav {
                background-color: #ffffff;
                overflow: hidden;
                border-bottom: 2px solid #ddd;
                display: flex;
                justify-content: flex-start;
                flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
                border-radius: 8px 8px 0 0;
            }
            .tab-button {
                background-color: inherit;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 14px 20px;
                font-size: 1rem;
                font-weight: 500;
                color: #555;
                transition: 0.3s;
                border-bottom: 3px solid transparent;
                margin-bottom: -2px;
            }
            .tab-button:hover { background-color: #f9f9f9; color: #111; }
            .tab-button.active {
                color: #3498db; /* Azul */
                font-weight: 600;
                border-bottom: 3px solid #3498db;
            }

            /* Conteúdo das Abas */
            .tab-content {
                display: none;
                padding: 20px;
                border: 1px solid #ddd;
                background-color: white;
                border-top: none;
                border-radius: 0 0 8px 8px;
                animation: fadeIn 0.5s;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .tab-content.active { display: block; }
            
            h2, h3 {
                color: #2c3e50;
                border-bottom: 2px solid #f4f7f6;
                padding-bottom: 10px;
                margin-top: 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            /* Formulários */
            .form-container {
                display: grid;
                grid-template-columns: 1fr; 
                gap: 15px;
            }
            @media (min-width: 600px) {
                .form-container { grid-template-columns: 1fr 1fr; }
            }
            .form-container-prod {
                grid-template-columns: 1fr;
            }
            @media (min-width: 700px) {
                .form-container-prod {
                    grid-template-columns: 1fr 1fr 1fr;
                }
            }
            .form-container-3col {
                grid-template-columns: 1fr;
            }
            @media (min-width: 700px) {
                .form-container-3col {
                    grid-template-columns: 2fr 1fr 1fr;
                }
            }
            .form-container-contagem {
                grid-template-columns: 1fr;
            }
             @media (min-width: 700px) {
                .form-container-contagem {
                    grid-template-columns: 1fr 1fr 1fr 1fr;
                }
            }


            .form-group { display: flex; flex-direction: column; }
            .form-group label {
                margin-bottom: 5px;
                font-weight: 600;
                font-size: 0.9em;
                color: #555;
            }
            .form-group input, .form-group select {
                padding: 12px;
                border: 1px solid #ccc;
                border-radius: 6px;
                font-size: 1em;
                background-color: #fdfdfd;
            }
            .form-group input:focus, .form-group select:focus {
                outline: none;
                border-color: #3498db;
                box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            }
            
            /* Botões */
            .submit-button {
                grid-column: 1 / -1; 
                padding: 12px;
                background-color: #27ae60; /* Verde */
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1.1em;
                font-weight: 600;
                transition: background-color 0.3s;
            }
            .submit-button:hover { background-color: #219150; }
            
            .secondary-button {
                padding: 10px 15px;
                background-color: #3498db; /* Azul */
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9em;
                font-weight: 500;
                transition: background-color 0.3s;
                margin-top: 5px;
            }
            .secondary-button:hover { background-color: #2980b9; }

            .copy-button {
                background-color: #9b59b6; /* Roxo */
                font-size: 0.8em;
                padding: 8px 12px;
                margin-left: 10px;
            }
            .copy-button:hover {
                background-color: #8e44ad;
            }
            .copy-button.copied { /* Feedback de cópia */
                background-color: #27ae60; /* Verde */
            }

            .export-button {
                background-color: #16a085; /* Verde (diferente) */
                font-size: 0.8em;
                padding: 8px 12px;
                margin-left: auto;
            }
            .export-button:hover {
                background-color: #117a65;
            }

            hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
            ul { line-height: 1.6; }

            /* Tabela */
            .table-container {
                width: 100%;
                overflow-x: auto; /* Para rolagem em telas pequenas */
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 10px;
                text-align: left;
                vertical-align: middle;
            }
            th { background-color: #f9f9f9; font-weight: 600; }
            tr:nth-child(even) { background-color: #fdfdfd; }
            
            tbody:empty::after {
                content: "Carregando dados do Firebase...";
                display: table-cell;
                padding: 15px;
                text-align: center;
                color: #888;
                font-style: italic;
            }
            
            /* Tabela de Resumo */
            .resumo-table td:last-child {
                font-weight: bold;
                font-size: 1.1em;
                text-align: right;
            }
            .resumo-table tr:hover {
                background-color: #f5faff;
            }

            /* Ingredientes na ficha técnica */
            .ingrediente-item {
                display: grid;
                grid-template-columns: 2fr 1fr 1fr;
                gap: 10px;
                align-items: center;
                padding: 10px;
                border: 1px dashed #ccc;
                border-radius: 6px;
                margin-bottom: 10px;
            }
            .ingrediente-item button {
                background-color: #e74c3c;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 8px;
                cursor: pointer;
            }
            .ingredientes-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                font-size: 0.9em;
            }
            .ingredientes-list li {
                border-bottom: 1px solid #eee;
                padding: 2px 0;
            }
            .ingredientes-list li:last-child {
                border-bottom: none;
            }
            
            /* Filtro de Relatório e Contagem */
            .filtro-container {
                background-color: #fdfdfd;
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
                align-items: flex-end;
            }
            @media (max-width: 600px) {
                .filtro-container {
                    grid-template-columns: 1fr;
                }
            }
            
            /* Contêiner para botões da tabela */
            .table-header-buttons {
                display: flex;
                margin-left: auto; /* Joga para a direita */
            }
        `;
        document.head.appendChild(style);


        // --- FUNÇÕES DE INICIALIZAÇÃO E DADOS ---

        async function initFirebase() {
            try {
                // USA A CONFIGURAÇÃO MANUAL NO TOPO DO SCRIPT
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                // Listener principal de autenticação
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // --- UTILIZADOR ESTÁ LOGADO ---
                        userId = user.uid;
                        console.log("Utilizador logado:", userId);
                        
                        // Define os caminhos das coleções
                        const dataPath = `artifacts/${appId}/public/data`;
                        itensCol = collection(db, `${dataPath}/itens`);
                        producaoCol = collection(db, `${dataPath}/producao`);
                        contagemCol = collection(db, `${dataPath}/contagem`);
                        fichasCol = collection(db, `${dataPath}/fichas`);
                        vendasCol = collection(db, `${dataPath}/vendas`);
                        
                        userRolesCol = collection(db, `user-roles`); 

                        // Busca a função (role) do utilizador
                        const userRoleDoc = await getDoc(doc(userRolesCol, userId));
                        
                        if (userRoleDoc.exists()) {
                            const userData = userRoleDoc.data();
                            userRole = userData.funcao; 
                            userNameDisplay.textContent = `Olá, ${userData.nome || 'Utilizador'}`;
                            
                            setupUIForRole(userRole);
                            carregarDadosListeners();
                            
                            appContainer.style.display = 'block';
                            loginContainer.style.display = 'none'; // Esconde login
                            registerContainer.style.display = 'none'; // Esconde registo
                            loginError.style.display = 'none';
                            registerError.style.display = 'none';

                        } else {
                            console.error("Utilizador sem função (role) definida na base de dados.");
                            // Se foi um registo novo, pode demorar 1s
                            setTimeout(async () => {
                                const retryDoc = await getDoc(doc(userRolesCol, userId));
                                if (retryDoc.exists()) {
                                    // Funcionou na segunda tentativa
                                    const userData = retryDoc.data();
                                    userRole = userData.funcao; 
                                    userNameDisplay.textContent = `Olá, ${userData.nome || 'Utilizador'}`;
                                    setupUIForRole(userRole);
                                    carregarDadosListeners();
                                    appContainer.style.display = 'block';
                                    loginContainer.style.display = 'none';
                                    registerContainer.style.display = 'none';
                                } else {
                                    // Falhou mesmo
                                    alert("Erro: A sua conta não tem permissões. Contacte o administrador.");
                                    await signOut(auth);
                                }
                            }, 1500); // Espera 1.5s
                        }
                        
                    } else {
                        // --- UTILIZADOR ESTÁ DESLOGADO ---
                        console.log("Utilizador deslogado.");
                        userId = null;
                        userRole = null;
                        
                        listeners.forEach(unsubscribe => unsubscribe());
                        listeners = [];
                        
                        itensDB = [], producaoDB = [], contagemDB = [], fichasDB = [], vendasDB = [];
                        
                        appContainer.style.display = 'none';
                        loginContainer.style.display = 'flex'; // Mostra login
                        registerContainer.style.display = 'none'; // Esconde registo
                        userNameDisplay.textContent = '';
                        document.body.className = ''; 
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                // Remove a verificação antiga de __firebase_config
                alert("Erro de conexão com o Firebase: " + error.message);
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSy")) {
                    // Este é um alerta suave, pois a chave parece estar lá
                    console.warn("Verifique se a chave API do Firebase está correta.");
                } else if (firebaseConfig.apiKey === "COLE-A-SUA-CHAVE-AQUI") {
                     alert("ERRO CRÍTICO: Você não colou a sua firebaseConfig no código!");
                }
            }
        }
        
        // NOVO: Controla a UI baseado na Função (Role)
        function setupUIForRole(role) {
            // Adiciona a classe ao body para controlar CSS (ex: botões delete)
            document.body.className = `role-${role}`;
            
            // Seleciona todos os botões das abas
            const tabItens = document.querySelector('[onclick*="itens"]');
            const tabProducao = document.querySelector('[onclick*="producao"]');
            const tabContagem = document.querySelector('[onclick*="contagem"]');
            const tabVendas = document.querySelector('[onclick*="vendas"]');
            const tabRelatorio = document.querySelector('[onclick*="relatorio"]');

            // Esconde todas por defeito
            [tabItens, tabProducao, tabContagem, tabVendas, tabRelatorio].forEach(tab => {
                if(tab) tab.classList.add('tab-hidden');
            });

            // Mostra abas baseado na função
            switch (role) {
                case "Proprietário":
                    [tabItens, tabProducao, tabContagem, tabVendas, tabRelatorio].forEach(tab => {
                        if(tab) tab.classList.remove('tab-hidden');
                    });
                    // Mostra a primeira aba visível
                    showTab('itens', tabItens);
                    break;
                case "Produção":
                    [tabItens, tabProducao, tabContagem].forEach(tab => {
                        if(tab) tab.classList.remove('tab-hidden');
                    });
                    showTab('itens', tabItens);
                    break;
                case "Compras":
                    [tabVendas, tabRelatorio].forEach(tab => {
                        if(tab) tab.classList.remove('tab-hidden');
                    });
                    showTab('vendas', tabVendas);
                    break;
                default:
                    // Nenhuma aba visível se a função não for reconhecida
                    console.warn("Função desconhecida:", role);
                    break;
            }
        }

        // `carregarDados` agora apenas inicia os listeners
        function carregarDadosListeners() {
            // Limpa listeners antigos
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];

            // Listener para Itens
            listeners.push(onSnapshot(itensCol, (snapshot) => {
                itensDB = [];
                snapshot.forEach(doc => {
                    itensDB.push({ ...doc.data(), id: doc.id }); // Armazena o ID do documento
                });
                console.log("Itens carregados:", itensDB.length);
                renderizarTabelaItens();
                atualizarDropdownsItens();
            }, (error) => console.error("Erro ao carregar itens:", error)));
            
            // Listener para Produção
            listeners.push(onSnapshot(producaoCol, (snapshot) => {
                producaoDB = [];
                snapshot.forEach(doc => {
                    producaoDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Produção carregada:", producaoDB.length);
                renderizarTabelaProducao();
                renderizarResumoProducao();
            }, (error) => console.error("Erro ao carregar produção:", error)));

            // Listener para Contagem
            listeners.push(onSnapshot(contagemCol, (snapshot) => {
                contagemDB = [];
                snapshot.forEach(doc => {
                    contagemDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Contagem carregada:", contagemDB.length);
                renderizarTabelaContagem(true); // Re-renderiza a tabela com filtro
            }, (error) => console.error("Erro ao carregar contagem:", error)));
            
            // Listener para Fichas
            listeners.push(onSnapshot(fichasCol, (snapshot) => {
                fichasDB = [];
                snapshot.forEach(doc => {
                    fichasDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Fichas carregadas:", fichasDB.length);
                renderizarTabelaFichas();
                atualizarSelectPratosVenda();
            }, (error) => console.error("Erro ao carregar fichas:", error)));
            
            // Listener para Vendas
            listeners.push(onSnapshot(vendasCol, (snapshot) => {
                vendasDB = [];
                snapshot.forEach(doc => {
                    vendasDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Vendas carregadas:", vendasDB.length);
                renderizarTabelaVendas();
            }, (error) => console.error("Erro ao carregar vendas:", error)));

            // Adiciona o primeiro ingrediente na Ficha Técnica (após dados carregarem)
            if (ingredientesContainer.children.length === 0) {
                adicionarCampoIngrediente();
            }
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO (VISUAL) ---
        
        // Modificado para usar o ID do Documento
        function renderizarTabelaItens() {
            listaItens.innerHTML = '';
            itensDB.sort((a,b) => a.nome.localeCompare(b.nome));
            itensDB.forEach(item => { // 'index' não é mais necessário
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.nome}</td>
                    <td>${item.categoria}</td>
                    <td>
                        <button class="action-button" onclick="excluirItemItem('${item.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaItens.appendChild(tr);
            });
        }
        
        function atualizarDropdownsItens() {
            let options = '<option value="">Selecione um item...</option>';
            itensDB.forEach(item => {
                options += `<option value="${item.nome}">${item.nome}</option>`;
            });
            
            prodProteina.innerHTML = options;
            contProteina.innerHTML = options;
        }

        // Modificado para usar o ID do Documento
        function renderizarTabelaProducao() {
            listaProducao.innerHTML = ''; 
            producaoDB.sort((a,b) => b.data.localeCompare(a.data)); // Ordena
            producaoDB.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(item.data)}</td>
                    <td>${item.colaborador}</td>
                    <td>${item.proteina}</td>
                    <td>${item.pesoKg || '-'} kg</td>
                    <td>${item.porcaoGramas || '-'} g</td>
                    <td>${item.numPorcoes}</td>
                    <td>
                        <button class="action-button" onclick="excluirItemProducao('${item.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaProducao.appendChild(tr);
            });
        }
        
        function renderizarResumoProducao() {
            resumoProducao.innerHTML = '';
            const totais = {};
            producaoDB.forEach(item => {
                const porcoes = item.numPorcoes || 0;
                totais[item.proteina] = (totais[item.proteina] || 0) + porcoes;
            });
            const proteinasOrdenadas = Object.keys(totais).sort();
            proteinasOrdenadas.forEach(proteina => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${proteina}</strong></td>
                    <td>${totais[proteina]} porções</td>
                `;
                resumoProducao.appendChild(tr);
            });
        }
        
        // Modificado para usar o ID do Documento
        function renderizarTabelaContagem(usarFiltro = false) {
            listaContagem.innerHTML = '';
            let dataInicio = '1970-01-01';
            let dataFim = '2099-12-31';
            if (usarFiltro) {
                 dataInicio = contFiltroDataInicio.value || '1970-01-01';
                 dataFim = contFiltroDataFim.value || '2099-12-31';
            }
            
            const contagensFiltradas = contagemDB
                .filter(item => item.data >= dataInicio && item.data <= dataFim)
                .sort((a,b) => b.data.localeCompare(a.data));

            contagensFiltradas.forEach(item => {
                const itemInfo = itensDB.find(i => i.nome === item.proteina);
                const categoria = (itemInfo && itemInfo.categoria) ? itemInfo.categoria : 'Sem Categoria';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(item.data)}</td>
                    <td>${item.local || '-'}</td>
                    <td>${item.proteina}</td>
                    <td>${categoria}</td>
                    <td>${item.quantidade}</td>
                    <td>${item.unidade}</td>
                    <td>
                        <button class="action-button" onclick="excluirItemContagem('${item.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaContagem.appendChild(tr);
            });
        }
        
        // Modificado para usar o ID do Documento
        function renderizarTabelaFichas() {
            listaFichas.innerHTML = '';
            fichasDB.forEach(ficha => {
                const tr = document.createElement('tr');
                const ingredientesHtml = ficha.ingredientes.map(ing => {
                    return `<li class="ingredientes-list-item">
                                <strong>${ing.proteina}:</strong> ${ing.qtdPorcoes} porção(ões)
                            </li>`;
                }).join('');
                tr.innerHTML = `
                    <td>${ficha.nomePrato}</td>
                    <td>${ficha.tipoPrato}</td>
                    <td><ul class="ingredientes-list">${ingredientesHtml}</ul></td>
                    <td>
                        <button class="action-button" onclick="excluirItemFicha('${ficha.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaFichas.appendChild(tr);
            });
        }
        
        // Modificado para usar o ID do Documento
        function renderizarTabelaVendas() {
            listaVendas.innerHTML = '';
            vendasDB.sort((a,b) => b.data.localeCompare(a.data)); // Ordena
            vendasDB.forEach(venda => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarData(venda.data)}</td>
                    <td>${venda.nomePrato}</td>
                    <td>${venda.quantidade}</td>
                    <td>
                        <button class="action-button" onclick="excluirItemVenda('${venda.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaVendas.appendChild(tr);
            });
        }
        
        function criarSelectProteinasHTML() {
            let options = '<option value="">Selecione o Item...</option>';
            itensDB.forEach(item => {
                options += `<option value="${item.nome}">${item.nome}</option>`;
            });
            return `<select class="ficha-ingrediente-proteina" required>${options}</select>`;
        }
        
        function atualizarSelectPratosVenda() {
            vendaPratoSelect.innerHTML = '<option value="">Selecione um prato</option>';
            const nomesPratos = [...new Set(fichasDB.map(ficha => ficha.nomePrato))].sort();
            nomesPratos.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;
                vendaPratoSelect.appendChild(option);
            });
        }

        // --- LÓGICA DE EVENTOS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa o Firebase
            initFirebase();
            
            // Define as datas padrão
            const hoje = new Date().toISOString().split('T')[0];
            prodData.value = hoje;
            contData.value = hoje;
            vendaData.value = hoje;
            const dataFim = new Date();
            const dataInicio = new Date();
            dataInicio.setDate(dataFim.getDate() - 6);
            filtroDataInicio.value = dataInicio.toISOString().split('T')[0];
            filtroDataFim.value = dataFim.toISOString().split('T')[0];
            contFiltroDataInicio.value = hoje;
            contFiltroDataFim.value = hoje;
            
            // Botões de Exportação
            document.getElementById('export-itens').addEventListener('click', exportarItens);
            document.getElementById('export-producao').addEventListener('click', exportarProducao);
            document.getElementById('export-contagem').addEventListener('click', exportarContagem);
            document.getElementById('export-fichas').addEventListener('click', exportarFichas);
            document.getElementById('export-vendas').addEventListener('click', exportarVendas);
            document.getElementById('export-relatorio').addEventListener('click', exportarRelatorio);
            
            // Botões de Filtro e Ação
            filtroRelatorioBtn.addEventListener('click', () => {
                calcularRelatorioBalanço(filtroDataInicio.value, filtroDataFim.value);
            });
            contFiltroBtn.addEventListener('click', () => renderizarTabelaContagem(true));
            copiarContagemBtn.addEventListener('click', copiarContagemFormatada);
            
            // NOVO: Event listener para Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // ALTERAÇÃO: Converte Nome (Login) para um email
                const name = loginName.value.trim();
                const email = `${name.toLowerCase()}@numar.app`; // O seu domínio de app
                const password = loginPassword.value;
                loginError.style.display = 'none';
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // O onAuthStateChanged vai tratar do resto
                } catch (error) {
                    console.error("Erro ao fazer login:", error.code);
                    loginError.textContent = "Login ou senha inválidos.";
                    loginError.style.display = 'block';
                }
            });
            
            // NOVO: Event listener para Logout
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // O onAuthStateChanged vai tratar do resto
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                }
            });
            
            // NOVO: Listeners para trocar entre Login e Registo
            showRegisterLink.addEventListener('click', () => {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'flex';
            });
            showLoginLink.addEventListener('click', () => {
                loginContainer.style.display = 'flex';
                registerContainer.style.display = 'none';
            });
            
            // NOVO: Event listener para formulário de Registo
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nomeCompleto = registerNomeCompleto.value.trim();
                const nomeLogin = registerNomeLogin.value.trim();
                const password = registerPassword.value;
                const funcao = registerFuncao.value;
                registerError.style.display = 'none';

                if (!nomeCompleto || !nomeLogin || !password || !funcao) {
                    registerError.textContent = "Preencha todos os campos.";
                    registerError.style.display = 'block';
                    return;
                }
                
                // Segurança: Não permitir que alguém se registe como Proprietário
                if (funcao === "Proprietário") {
                    registerError.textContent = "Função inválida.";
                    registerError.style.display = 'block';
                    return;
                }
                
                const email = `${nomeLogin.toLowerCase()}@numar.app`;
                
                try {
                    // 1. Cria o utilizador no Authentication
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // 2. Define a função (role) no Firestore
                    // Re-define userRolesCol aqui para garantir que existe
                    userRolesCol = collection(db, `user-roles`); 
                    await setDoc(doc(userRolesCol, user.uid), {
                        nome: nomeCompleto,
                        funcao: funcao
                    });
                    
                    // Sucesso! O onAuthStateChanged vai tratar de logar o utilizador
                    
                } catch (error) {
                    console.error("Erro ao registar:", error.code);
                    if (error.code === 'auth/email-already-in-use') {
                        registerError.textContent = "Este Nome de Login já está em uso.";
                    } else if (error.code === 'auth/weak-password') {
                        registerError.textContent = "A senha deve ter pelo menos 6 caracteres.";
                    } else {
                        registerError.textContent = "Erro ao criar conta.";
                    }
                    registerError.style.display = 'block';
                }
            });

            // Event listener para formulário de Itens
            formItens.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = itemNome.value.trim();
                const categoria = itemCategoria.value.trim();
                if (!nome || !categoria) return alert("Preencha Nome e Categoria.");
                if (itensDB.some(item => item.nome.toLowerCase() === nome.toLowerCase())) {
                    return alert("Este nome de item já existe.");
                }
                
                try {
                    await addDoc(itensCol, { nome, categoria });
                    itemNome.value = '';
                    itemCategoria.value = '';
                    itemNome.focus();
                } catch (error) {
                    console.error("Erro ao salvar item:", error);
                    alert("Erro ao salvar item.");
                }
                // Renderização será feita pelo onSnapshot
            });
        });

        // --- Formulário Produção ---
        formProducao.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const data = prodData.value;
            const colaborador = prodColaborador.value.trim();
            const proteina = prodProteina.value;
            const pesoKg = parseFloat(prodPeso.value) || null;
            const porcaoGramas = parseInt(prodPorcao.value) || null;
            const numPorcoes = parseInt(prodNumPorcoes.value); 
            if (!data || !colaborador || !proteina || isNaN(numPorcoes) || numPorcoes <= 0) {
                 return alert("Preencha Data, Colaborador, selecione um Item e Nº de Porções.");
            }
            
            try {
                await addDoc(producaoCol, { data, colaborador, proteina, pesoKg, porcaoGramas, numPorcoes });
                prodColaborador.value = '';
                prodProteina.value = '';
                prodPeso.value = '';
                prodPorcao.value = '';
                prodNumPorcoes.value = '';
                prodColaborador.focus(); 
            } catch (error) {
                console.error("Erro ao salvar produção:", error);
                alert("Erro ao salvar produção.");
            }
        });
        
        // --- Formulário Contagem ---
        formContagem.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = contData.value;
            const local = contLocal.value.trim() || null;
            const proteina = contProteina.value;
            const unidade = contUnidade.value.trim();
            const quantidade = parseInt(contQuantidade.value);
            if (!data || !proteina || !unidade || isNaN(quantidade) || quantidade < 0) {
                return alert("Preencha Data, selecione um Item, Unidade e Quantidade.");
            }
            
            try {
                await addDoc(contagemCol, { data, local, proteina, unidade, quantidade });
                contFiltroDataInicio.value = data;
                contFiltroDataFim.value = data;
                contLocal.value = '';
                contProteina.value = '';
                contQuantidade.value = '';
                contUnidade.value = 'Porções';
                contProteina.focus();
            } catch (error) {
                console.error("Erro ao salvar contagem:", error);
                alert("Erro ao salvar contagem.");
            }
        });

        // --- Formulário Ficha Técnica ---
        
        function adicionarCampoIngrediente() {
            const div = document.createElement('div');
            div.className = 'ingrediente-item';
            div.innerHTML = `
                <div class="form-group">
                    <label>Item (Cadastrado)</label>
                    ${criarSelectProteinasHTML()}
                </div>
                <div class="form-group">
                    <label>Qtd. Porções</label>
                    <input type="number" class="ficha-ingrediente-qtd" value="1" min="1" required>
                </div>
                <button type="button" onclick="removerCampoIngrediente(this)">X</button>
            `;
            ingredientesContainer.appendChild(div);
        }
        
        window.removerCampoIngrediente = (botao) => {
            botao.parentElement.remove();
        }

        addIngredienteBtn.addEventListener('click', adicionarCampoIngrediente);

        formFicha.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nomePrato = fichaNomePrato.value.trim();
            const tipoPrato = fichaTipoPrato.value;
            if (!nomePrato || !tipoPrato) return;
            
            const ingredientes = [];
            const camposIngredientes = ingredientesContainer.querySelectorAll('.ingrediente-item');
            if (camposIngredientes.length === 0) return alert("Adicione pelo menos um ingrediente.");
            
            let formValido = true;
            camposIngredientes.forEach(item => {
                const proteina = item.querySelector('.ficha-ingrediente-proteina').value;
                const qtdPorcoes = parseInt(item.querySelector('.ficha-ingrediente-qtd').value);
                if (!proteina || isNaN(qtdPorcoes) || qtdPorcoes <= 0) formValido = false;
                ingredientes.push({ proteina, qtdPorcoes });
            });
            
            if (!formValido) return alert("Verifique os ingredientes.");
            
            try {
                await addDoc(fichasCol, { nomePrato, tipoPrato, ingredientes });
                fichaNomePrato.value = '';
                fichaTipoPrato.value = '';
                ingredientesContainer.innerHTML = '';
                adicionarCampoIngrediente(); 
                fichaNomePrato.focus();
            } catch (error) {
                console.error("Erro ao salvar ficha:", error);
                alert("Erro ao salvar ficha técnica.");
            }
        });
        
        // --- Formulário Registrar Venda ---
        
        formVenda.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = vendaData.value;
            const nomePrato = vendaPratoSelect.value;
            const quantidade = parseInt(vendaQuantidade.value); 
            if (!data || !nomePrato || isNaN(quantidade) || quantidade <= 0) {
                return alert("Preencha Data, Prato e Quantidade Vendida.");
            }
            
            try {
                await addDoc(vendasCol, { data, nomePrato, quantidade });
                vendaPratoSelect.value = '';
                vendaQuantidade.value = 1;
                vendaData.valueAsDate = new Date(); 
            } catch (error) {
                console.error("Erro ao salvar venda:", error);
                alert("Erro ao salvar venda.");
            }
        });

        // --- Funções de Excluir (Globais) ---
        
        // Modificado para usar ID do Documento
        window.excluirItemItem = async (docId) => {
            if (userRole !== 'Proprietário') return; // Segurança
            const item = itensDB.find(i => i.id === docId);
            if (!item) return;
            const itemNome = item.nome;
            const emUsoProducao = producaoDB.some(p => p.proteina === itemNome);
            const emUsoContagem = contagemDB.some(c => c.proteina === itemNome);
            const emUsoFicha = fichasDB.some(f => f.ingredientes.some(i => i.proteina === itemNome));
            if (emUsoProducao || emUsoContagem || emUsoFicha) {
                return alert("Não é possível excluir este item, pois ele já está sendo usado.");
            }
            try {
                await deleteDoc(doc(itensCol, docId));
            } catch (error) {
                console.error("Erro ao excluir item:", error);
            }
        }

        window.excluirItemProducao = async (docId) => {
            if (userRole !== 'Proprietário') return;
            try {
                await deleteDoc(doc(producaoCol, docId));
            } catch (error) {
                console.error("Erro ao excluir produção:", error);
            }
        }
        
        window.excluirItemContagem = async (docId) => {
            if (userRole !== 'Proprietário') return;
            try {
                await deleteDoc(doc(contagemCol, docId));
            } catch (error) {
                console.error("Erro ao excluir contagem:", error);
            }
        }

        window.excluirItemFicha = async (docId) => {
            if (userRole !== 'Proprietário') return;
            try {
                await deleteDoc(doc(fichasCol, docId));
            } catch (error) {
                console.error("Erro ao excluir ficha:", error);
            }
        }
        
        window.excluirItemVenda = async (docId) => {
            if (userRole !== 'Proprietário') return;
            try {
                await deleteDoc(doc(vendasCol, docId));
            } catch (error) {
                console.error("Erro ao excluir venda:", error);
            }
        }

        // --- TROCA DE ABAS (Navegação) ---
        
        window.showTab = (tabId, clickedButton) => {
            let allContent = document.querySelectorAll('.tab-content');
            allContent.forEach(content => content.classList.remove('active'));
            let allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Verifica se o botão clicado não está nulo (ex: no setup inicial da UI)
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            if (tabId === 'vendas' && ingredientesContainer.children.length === 0) {
                adicionarCampoIngrediente(); 
            }
            if (tabId === 'relatorio') {
                calcularRelatorioBalanço(filtroDataInicio.value, filtroDataFim.value);
            }
            // Outras renderizações são feitas pelos listeners (onSnapshot)
        }
        
        // --- RELATÓRIO (Lógica local, usa dados do cache) ---
        
        function calcularRelatorioBalanço(dataInicio, dataFim) {
            dataInicio = dataInicio || "1970-01-01";
            dataFim = dataFim || "2099-12-31";
            
            const relatorio = {}; 
            relatorioCache = []; 
            const todosOsItens = new Set(itensDB.map(i => i.nome));
            todosOsItens.forEach(item => {
                relatorio[item] = { inicial: 0, produzido: 0, vendido: 0, teorico: 0, fisico: null };
            });

            // 3. Busca Estoque INICIAL (usa cache local 'contagemDB')
            const contagensIniciais = contagemDB
                .filter(i => i.data < dataInicio && (i.unidade.toLowerCase() === 'porções' || i.unidade.toLowerCase() === 'porcoes'))
                .sort((a, b) => b.data.localeCompare(a.data)); 
            const contagensIniciaisFeitas = new Set();
            contagensIniciais.forEach(contagem => {
                if (relatorio[contagem.proteina] && !contagensIniciaisFeitas.has(contagem.proteina)) {
                    relatorio[contagem.proteina].inicial = contagem.quantidade;
                    contagensIniciaisFeitas.add(contagem.proteina);
                }
            });

            // 4. Calcula Produzido (usa cache local 'producaoDB')
            producaoDB
                .filter(i => i.data >= dataInicio && i.data <= dataFim)
                .forEach(prod => {
                    if (relatorio[prod.proteina]) {
                        relatorio[prod.proteina].produzido += prod.numPorcoes;
                    }
                });

            // 5. Calcula Vendido (usa caches locais 'vendasDB' e 'fichasDB')
            vendasDB
                .filter(i => i.data >= dataInicio && i.data <= dataFim)
                .forEach(venda => {
                    const ficha = fichasDB.find(f => f.nomePrato === venda.nomePrato);
                    if (ficha) {
                        ficha.ingredientes.forEach(ing => {
                            if (relatorio[ing.proteina]) {
                                relatorio[ing.proteina].vendido += (ing.qtdPorcoes * venda.quantidade);
                            }
                        });
                    }
                });
                
            // 6. Busca Estoque FINAL (usa cache local 'contagemDB')
            const contagensFinais = contagemDB
                .filter(i => i.data >= dataInicio && i.data <= dataFim && (i.unidade.toLowerCase() === 'porções' || i.unidade.toLowerCase() === 'porcoes'))
                .sort((a, b) => b.data.localeCompare(a.data)); 
            const contagensFinaisFeitas = new Set();
            contagensFinais.forEach(contagem => {
                if (relatorio[contagem.proteina] && !contagensFinaisFeitas.has(contagem.proteina)) {
                    relatorio[contagem.proteina].fisico = contagem.quantidade;
                    contagensFinaisFeitas.add(contagem.proteina);
                }
            });

            // 7. Renderiza a tabela
            listaRelatorio.innerHTML = '';
            const itensOrdenados = Object.keys(relatorio).sort();
            
            for (const item of itensOrdenados) {
                const dados = relatorio[item];
                if (dados.inicial === 0 && dados.produzido === 0 && dados.vendido === 0 && dados.fisico === null) continue;
                dados.teorico = dados.inicial + dados.produzido - dados.vendido;
                let diferenca = null;
                let statusHtml = '<em>Sem contagem final</em>';
                let trStyle = '';
                if (dados.fisico !== null) {
                    diferenca = dados.fisico - dados.teorico;
                    if (diferenca > 0) {
                        statusHtml = `<strong style="color: #27ae60;">Sobra: ${diferenca}</strong>`;
                        trStyle = 'background-color: #f0fef4;';
                    } else if (diferenca < 0) {
                        statusHtml = `<strong style="color: #e74c3c;">Falta: ${Math.abs(diferenca)}</strong>`;
                        trStyle = 'background-color: #fff0f0;';
                    } else {
                        statusHtml = `<strong>Zerado: 0</strong>`;
                    }
                }
                const tr = document.createElement('tr');
                tr.style = trStyle;
                tr.innerHTML = `
                    <td><strong>${item}</strong></td>
                    <td>${dados.inicial}</td>
                    <td>${dados.produzido}</td>
                    <td>${dados.vendido}</td>
                    <td>${dados.teorico}</td>
                    <td>${dados.fisico !== null ? dados.fisico : '-'}</td>
                    <td>${statusHtml}</td>
                `;
                listaRelatorio.appendChild(tr);
                relatorioCache.push({
                    item, ...dados,
                    status: (diferenca > 0 ? "Sobra" : (diferenca < 0 ? "Falta" : (diferenca === 0 ? "Zerado" : ""))),
                    valor: (diferenca !== null ? diferenca : "")
                });
            }
        }
        
        // --- FUNÇÕES UTILITÁRIAS ---
        
        function formatarData(dataISO) {
            if (!dataISO || !dataISO.includes('-')) return 'Data Inválida';
            const [ano, mes, dia] = dataISO.split('-');
            const dataObj = new Date(ano, mes - 1, dia);
            return dataObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        }

        // --- FUNÇÕES DE EXPORTAÇÃO E CÓPIA ---

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportarItens() {
            let csv = "Nome do Item;Categoria\n";
            itensDB.forEach(item => csv += [item.nome, item.categoria].join(';') + '\n');
            downloadCSV(csv, 'itens.csv');
        }

        function exportarProducao() {
            let csv = "Data;Colaborador;Item;Peso (kg);Porcao (g);Nº Porcoes\n";
            producaoDB.forEach(item => {
                csv += [
                    formatarData(item.data), item.colaborador, item.proteina,
                    item.pesoKg || '', item.porcaoGramas || '', item.numPorcoes
                ].join(';') + '\n';
            });
            downloadCSV(csv, 'producao.csv');
        }
        
        function exportarContagem() {
            let csv = "Data;Local;Item;Categoria;Quantidade;Unidade\n";
            const dataInicio = contFiltroDataInicio.value || '1970-01-01';
            const dataFim = contFiltroDataFim.value || '2099-12-31';
            contagemDB
                .filter(item => item.data >= dataInicio && item.data <= dataFim)
                .forEach(item => {
                    const itemInfo = itensDB.find(i => i.nome === item.proteina);
                    const categoria = (itemInfo && itemInfo.categoria) ? itemInfo.categoria : 'Sem Categoria';
                    csv += [
                        formatarData(item.data), item.local || '', item.proteina,
                        categoria, item.quantidade, item.unidade
                    ].join(';') + '\n';
            });
            downloadCSV(csv, `contagem_${dataInicio}_a_${dataFim}.csv`);
        }

        function exportarFichas() {
            let csv = "Nome Prato;Tipo Prato;Item (Ingrediente);Qtd. Porcoes\n";
            fichasDB.forEach(ficha => {
                ficha.ingredientes.forEach(ing => {
                    csv += [ficha.nomePrato, ficha.tipoPrato, ing.proteina, ing.qtdPorcoes].join(';') + '\n';
                });
            });
            downloadCSV(csv, 'fichas_tecnicas.csv');
        }

        function exportarVendas() {
            let csv = "Data;Prato Vendido;Quantidade (Pratos)\n";
            vendasDB.forEach(venda => {
                csv += [formatarData(venda.data), venda.nomePrato, venda.quantidade].join(';') + '\n';
            });
            downloadCSV(csv, 'vendas.csv');
        }

        function exportarRelatorio() {
            let csv = "Item;Est. Inicial;Produzido;Vendido;Est. Teorico;Est. Fisico;Status;Valor\n";
            relatorioCache.forEach(item => {
                 csv += [
                    item.item, item.inicial, item.produzido, item.vendido,
                    item.teorico, item.fisico, item.status, item.valor
                ].join(';') + '\n';
            });
            const de = filtroDataInicio.value || 'inicio';
            const ate = filtroDataFim.value || 'fim';
            downloadCSV(csv, `relatorio_balanco_${de}_ate_${ate}.csv`);
        }
        
        function copiarContagemFormatada() {
            const dataInicio = contFiltroDataInicio.value;
            const dataFim = contFiltroDataFim.value;
            const contagensFiltradas = contagemDB.filter(item => item.data >= dataInicio && item.data <= dataFim);
            const contagensComCategoria = contagensFiltradas.map(item => {
                const itemInfo = itensDB.find(i => i.nome === item.proteina);
                const categoria = (itemInfo && itemInfo.categoria) ? itemInfo.categoria : 'Sem Categoria';
                return { ...item, categoria };
            });
            contagensComCategoria.sort((a, b) => {
                if (a.categoria !== b.categoria) return a.categoria.localeCompare(b.categoria);
                const localA = a.local || 'ZZZ';
                const localB = b.local || 'ZZZ';
                return localA.localeCompare(localB);
            });
            
            let texto = dataInicio === dataFim ? `*CONTAGEM (${formatarData(dataInicio)})*\n` : `*CONTAGEM (${formatarData(dataInicio)} a ${formatarData(dataFim)})*\n`;
            if (contagensComCategoria.length === 0) {
                texto += "\nNenhuma contagem registrada no período.";
            } else {
                let categoriaAtual = null, localAtual = null;
                contagensComCategoria.forEach(item => {
                    if (item.categoria !== categoriaAtual) {
                        texto += `\n*${item.categoria.toUpperCase()}*\n`;
                        categoriaAtual = item.categoria;
                        localAtual = null;
                    }
                    const local = item.local || "Outros";
                    if (local !== localAtual) {
                        texto += `_${local}_\n`;
                        localAtual = local;
                    }
                    texto += `- ${item.proteina}: *${item.quantidade} ${item.unidade}*\n`;
                });
            }
            copiarFallback(texto);
        }

        function copiarFallback(texto) {
            const textArea = document.createElement("textarea");
            textArea.value = texto;
            textArea.style.position = "fixed";
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) feedbackBotaoCopiado();
                else alert("Não foi possível copiar. Tente manualmente.");
            } catch (err) {
                console.error("Erro ao copiar (fallback):", err);
                alert("Não foi possível copiar. Tente manually.");
            }
            document.body.removeChild(textArea);
        }
        
        function feedbackBotaoCopiado() {
            const botao = copiarContagemBtn;
            if (!botao) return;
            const textoOriginal = "Copiar Contagem";
            botao.textContent = 'Copiado!';
            botao.classList.add('copied');
            setTimeout(() => {
                botao.textContent = textoOriginal;
                botao.classList.remove('copied');
            }, 2000);
        }

    </script>

    <!-- HTML da Página -->
    
    <!-- NOVO: Tela de Login (Visível por padrão) -->
    <div id="login-container" class="auth-container">
        <form id="login-form" class="auth-form">
            <h2>Controle de Produção Numar</h2>
            <div class="form-group">
                <label for="login-name">Nome (Login)</label>
                <input type="text" id="login-name" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" required autocomplete="current-password">
            </div>
            <button type="submit">Entrar</button>
            <p id="login-error" class="auth-error"></p>
            <p id="show-register-link" class="auth-link">Não tem conta? Crie uma aqui.</p>
        </form>
    </div>
    
    <!-- NOVO: Tela de Registo (Oculta por padrão) -->
    <div id="register-container" class="auth-container">
        <form id="register-form" class="auth-form">
            <h2>Criar Nova Conta</h2>
            <div class="form-group">
                <label for="register-nome-completo">Seu Nome Completo</label>
                <input type="text" id="register-nome-completo" required>
            </div>
            <div class="form-group">
                <label for="register-nome-login">Nome de Login (Ex: vitor)</label>
                <input type="text" id="register-nome-login" required>
            </div>
            <div class="form-group">
                <label for="register-password">Senha (mín. 6 caracteres)</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="register-funcao">Sua Função</label>
                <select id="register-funcao" required>
                    <option value="">Selecione...</option>
                    <option value="Produção">Produção</option>
                    <option value="Compras">Compras</option>
                    <!-- "Proprietário" é omitido por segurança -->
                </select>
            </div>
            <button type="submit">Registar</button>
            <p id="register-error" class="auth-error"></p>
            <p id="show-login-link" class="auth-link">Já tem conta? Entre aqui.</p>
        </form>
    </div>
    
    <!-- NOVO: App (Oculto por padrão) -->
    <div id="app-container">
        <header>
            <h1>Controle de Produção Numar</h1>
            <!-- NOVO: Info do Usuário e Logout -->
            <div class="header-info">
                <span id="user-name-display"></span>
                <button id="logout-button">Sair</button>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-button" onclick="showTab('itens', this)">Itens</button>
            <button class="tab-button" onclick="showTab('producao', this)">Produção</button>
            <button class="tab-button" onclick="showTab('contagem', this)">Contagem</button>
            <button class="tab-button" onclick="showTab('vendas', this)">Vendas</button>
            <button class="tab-button" onclick="showTab('relatorio', this)">Relatório</button>
        </nav>

        <main>
            <!-- Aba Itens -->
            <div id="itens" class="tab-content">
                <h2>Cadastro de Itens e Categorias</h2>
                <p>Cadastre aqui todos os seus itens. Isso garantirá a padronização em todo o sistema.</p>
                <form id="form-itens" class="form-container">
                    <div class="form-group">
                        <label for="item-nome">Nome do Item (Ex: Pescada 200g)</label>
                        <input type="text" id="item-nome" placeholder="Nome único do item" required>
                    </div>
                    <div class="form-group">
                        <label for="item-categoria">Categoria</label>
                        <input type="text" id="item-categoria" list="lista-categorias" placeholder="Ex: Proteínas" required>
                        <datalist id="lista-categorias">
                            <option value="Proteínas"></option>
                            <option value="Acompanhamentos"></option>
                            <option value="Bebidas"></option>
                            <option value="Descartáveis"></option>
                            <option value="Hortifruti"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Salvar Novo Item</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Itens Cadastrados
                    <button id="export-itens" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Nome do Item</th><th>Categoria</th><th>Ação</th></tr></thead>
                        <tbody id="lista-itens"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Aba Produção -->
            <div id="producao" class="tab-content">
                <h2>Novo Lançamento (Produção)</h2>
                <p>Registre o que foi produzido (a proteína pronta).</p>
                <form id="form-producao" class="form-container form-container-prod">
                    <div class="form-group">
                        <label for="prod-data">Data</label>
                        <input type="date" id="prod-data" required>
                    </div>
                    <div class="form-group">
                        <label for="prod-colaborador">Colaborador</label>
                        <input type="text" id="prod-colaborador" placeholder="Nome" required>
                    </div>
                    <div class="form-group">
                        <label for="prod-proteina">Nome da Proteína/Item</label>
                        <select id="prod-proteina" required>
                            <option value="">Selecione um item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prod-peso">Peso Total (kg) (Opcional)</label>
                        <input type="number" id="prod-peso" step="0.001" placeholder="Ex: 10.5">
                    </div>
                    <div class="form-group">
                        <label for="prod-porcao">Porção (g) (Opcional)</label>
                        <input type="number" id="prod-porcao" placeholder="Ex: 200">
                    </div>
                    <div class="form-group">
                        <label for="prod-num-porcoes">Nº de Porções (Obrigatório)</label>
                        <input type="number" id="prod-num-porcoes" placeholder="Ex: 50" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Adicionar Lançamento</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Lançamentos de Produção
                    <button id="export-producao" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Colaborador</th><th>Item</th><th>Peso (kg)</th><th>Porção (g)</th><th>Nº Porções</th><th>Ação</th></tr></thead>
                        <tbody id="lista-producao"></tbody>
                    </table>
                </div>
                <hr>
                <h3>Resumo da Produção (Total)</h3>
                <div class="table-container">
                    <table class="resumo-table">
                        <thead><tr><th>Proteína</th><th>Total de Porções Produzidas</th></tr></thead>
                        <tbody id="resumo-producao"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Aba Contagem -->
            <div id="contagem" class="tab-content">
                <h2>Nova Contagem (Estoque Físico)</h2>
                <p>Registre o estoque físico (o que você encontrou na geladeira).</p>
                <form id="form-contagem" class="form-container form-container-contagem">
                    <div class="form-group">
                        <label for="cont-data">Data da Contagem</label>
                        <input type="date" id="cont-data" required>
                    </div>
                    <div class="form-group">
                        <label for="cont-local">Local (Opcional)</label>
                        <input type="text" id="cont-local" placeholder="Ex: Geladeira 1">
                    </div>
                    <div class="form-group">
                        <label for="cont-proteina">Nome do Item</label>
                        <select id="cont-proteina" required>
                            <option value="">Selecione um item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cont-unidade">Unidade</label>
                        <input type="text" id="cont-unidade" list="lista-unidades" value="Porções" required>
                        <datalist id="lista-unidades">
                            <option value="Porções"></option><option value="Peças"></option><option value="Kg"></option><option value="Unidades"></option><option value="Pacotes"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="cont-quantidade">Quantidade Contada</label>
                        <input type="number" id="cont-quantidade" min="0" placeholder="Ex: 50" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Salvar Contagem</button>
                    </div>
                </form>
                <hr>
                <div class="filtro-container">
                    <div class="form-group">
                        <label for="cont-filtro-data-inicio">De:</label>
                        <input type="date" id="cont-filtro-data-inicio">
                    </div>
                    <div class="form-group">
                        <label for="cont-filtro-data-fim">Até:</label>
                        <input type="date" id="cont-filtro-data-fim">
                    </div>
                    <div class="form-group">
                        <button id="cont-filtro-btn" class="secondary-button" style="width: 100%; padding: 12px;">Filtrar Tabela</button>
                    </div>
                </div>
                <h3>
                    Contagens Salvas (Filtrado)
                    <div class="table-header-buttons">
                        <button id="copiar-contagem-btn" class="secondary-button copy-button">Copiar Contagem</button>
                        <button id="export-contagem" class="secondary-button export-button">Exportar (CSV)</button>
                    </div>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Local</th><th>Item</th><th>Categoria</th><th>Quantidade</th><th>Unidade</th><th>Ação</th></tr></thead>
                        <tbody id="lista-contagem"></tbody>
                    </table>
                </div>
            </div>

            <!-- Aba Vendas -->
            <div id="vendas" class="tab-content">
                <h2>Vendas</h2>
                <h3>Registrar Prato (Ficha Técnica)</h3>
                <p>Crie a "Ficha Técnica" de um prato. Use os itens cadastrados na Produção.</p>
                <form id="form-ficha">
                    <div class="form-container" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="ficha-nome-prato">Nome do Prato</label>
                            <input type="text" id="ficha-nome-prato" placeholder="Ex: X-Tudo" required>
                        </div>
                        <div class="form-group">
                            <label for="ficha-tipo-prato">Tipo de Prato</label>
                            <select id="ficha-tipo-prato" required>
                                <option value="">Selecione o tipo</option><option value="Executivo">Executivo</option><option value="Compartilhado">Compartilhado</option><option value="Evento">Evento</option><option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <h4>Ingredientes (Itens da Produção)</h4>
                    <div id="ingredientes-container"></div>
                    <div class="form-group">
                        <button type="button" id="add-ingrediente-btn" class="secondary-button">+ Adicionar Item</button>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Salvar Ficha Técnica</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Fichas Técnicas Salvas
                    <button id="export-fichas" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Nome do Prato</th><th>Tipo</th><th>Ingredientes (Item | Qtd. Porções)</th><th>Ação</th></tr></thead>
                        <tbody id="lista-fichas"></tbody>
                    </table>
                </div>
                <hr>
                <h3>Registrar Venda</h3>
                <p>Registre a venda de um prato já cadastrado na Ficha Técnica.</p>
                <form id="form-venda" class="form-container">
                    <div class="form-group">
                        <label for="venda-data">Data da Venda</label>
                        <input type="date" id="venda-data" required>
                    </div>
                    <div class="form-group">
                        <label for="venda-prato">Selecione o Prato</label>
                        <select id="venda-prato" required><option value="">Carregando pratos...</option></select>
                    </div>
                    <div class="form-group">
                        <label for="venda-quantidade">Quantidade Vendida (Nº Pratos)</label>
                        <input type="number" id="venda-quantidade" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Registrar Venda</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Vendas Registradas
                    <button id="export-vendas" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Prato Vendido</th><th>Quantidade</th><th>Ação</th></tr></thead>
                        <tbody id="lista-vendas"></tbody>
                    </table>
                </div>
            </div>

            <!-- Aba Relatório -->
            <div id="relatorio" class="tab-content">
                <h2>
                    Relatório (Balanço de Estoque)
                    <button id="export-relatorio" class="secondary-button export-button">Exportar (CSV)</button>
                </h2>
                <p>Comparativo do estoque físico (Contado) vs. estoque teórico (Sistema). Apenas contagens em "Porções" são usadas no balanço.</p>
                <div class="filtro-container">
                    <div class="form-group">
                        <label for="filtro-data-inicio">Data Inicial</label>
                        <input type="date" id="filtro-data-inicio">
                    </div>
                    <div class="form-group">
                        <label for="filtro-data-fim">Data Final</label>
                        <input type="date" id="filtro-data-fim">
                    </div>
                    <div class="form-group">
                        <button id="filtro-relatorio-btn" class="secondary-button" style="width: 100%; padding: 12px;">Gerar Relatório</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Item</th><th>Est. Inicial (Contado)</th><th>Produzido (Entrada)</th><th>Vendido (Saída)</th><th>Est. Teórico (Final)</th><th>Est. Físico (Final)</th><th>Diferença (Sobra / Falta)</th></tr></thead>
                        <tbody id="lista-relatorio"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
</body>
</html>

