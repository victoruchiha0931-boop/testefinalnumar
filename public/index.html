<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produção (Online)</title>
    
    <!-- O CSS foi movido para o <head> -->
    <style>
        /* --- MELHORIA: Modo Noturno (CSS Variables) --- */
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --text-color-light: #555;
            --card-bg: white;
            --border-color: #ddd;
            --header-bg: #2c3e50;
            --table-header-bg: #f9f9f9;
            --table-row-bg: #fdfdfd;
            --table-row-hover: #f5faff;
            --input-bg: #fdfdfd;
            --input-border: #ccc;
            --button-primary-bg: #3498db;
            --button-primary-hover: #2980b9;
            --button-success-bg: #27ae60;
            --button-success-hover: #219150;
            --button-danger-bg: #e74c3c;
            --button-danger-hover: #c0392b;
            --button-warning-bg: #f39c12;
            --button-warning-hover: #e67e22;
            /* ATUALIZAÇÃO: Cores do Relatório */
            --relatorio-sobra-bg: #f0fef4;
            --relatorio-falta-bg: #fff0f0;
            --relatorio-sobra-text: #219150;
            --relatorio-falta-text: #c0392b;
        }
        body.dark-mode {
            --bg-color: #1a202c;
            --text-color: #e2e8f0;
            --text-color-light: #a0aec0;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --header-bg: #1e293b;
            --table-header-bg: #2d3748;
            --table-row-bg: #262f3e;
            --table-row-hover: #3c4a60;
            --input-bg: #2d3748;
            --input-border: #4a5568;
            /* ATUALIZAÇÃO: Cores do Relatório (Modo Noturno) */
            --relatorio-sobra-bg: #2d4a3c;
            --relatorio-falta-bg: #4a2d30;
            --relatorio-sobra-text: #38a169;
            --relatorio-falta-text: #e53e3e;
        }
        /* --- FIM Modo Noturno --- */

        /* Estilo geral */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color); /* Editado */
            color: var(--text-color); /* Editado */
            transition: background-color 0.2s, color 0.2s;
        }
        header {
            background-color: var(--header-bg); /* Editado */
            color: white;
            padding: 1rem 1.5rem; /* Reduzido padding */
            display: flex; /* Flexbox */
            justify-content: space-between; /* Alinha itens */
            align-items: center; /* Centraliza verticalmente */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { 
            margin: 0; 
            font-size: 1.25rem; /* Reduzido tamanho */
            text-align: left;
        }
        /* NOVO: Header Info (Usuário e Logout) */
        .header-info {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        #user-name-display {
            margin-right: 15px;
            font-weight: 500;
        }
        #logout-button {
            background-color: var(--button-danger-bg); /* Editado */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        #logout-button:hover {
            background-color: var(--button-danger-hover); /* Editado */
        }

        main {
            padding: 1rem;
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* NOVO: Telas de Login/Registo */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--bg-color); /* Editado */
        }
        .auth-form {
            background: var(--card-bg); /* Editado */
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        .auth-form h2 {
            text-align: center;
            margin-top: 0;
            color: var(--text-color); /* Editado */
        }
        .auth-form .form-group { margin-bottom: 1.25rem; }
        .auth-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .auth-form input, .auth-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border); /* Editado */
            border-radius: 6px;
            box-sizing: border-box; /* Garante padding correto */
            background-color: var(--input-bg); /* Editado */
            color: var(--text-color); /* Editado */
        }
        .auth-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--button-primary-bg); /* Editado */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-form .auth-link {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9em;
            color: var(--button-primary-bg); /* Editado */
            cursor: pointer;
        }
        .auth-form .auth-link:hover {
            text-decoration: underline;
        }
        .auth-error {
            color: var(--button-danger-bg); /* Editado */
            text-align: center;
            margin-top: 1rem;
            display: none; /* Oculto por padrão */
        }
        
        /* NOVO: Controle de Visibilidade */
        #app-container, #register-container {
            display: none; /* App e Registo ocultos por padrão */
        }
        #login-container {
             display: flex; /* Login visível por padrão */
        }

        .tab-hidden {
            display: none !important; /* Força esconder a aba */
        }
        /* Oculta botões de delete por padrão */
        .action-button {
            display: none;
        }
        /* Acesso de Proprietário: Mostra botões de delete */
        body.role-Proprietário .action-button {
            display: inline-block;
            background-color: var(--button-danger-bg); /* Editado */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        body.role-Proprietário .action-button:hover {
            background-color: var(--button-danger-hover); /* Editado */
        }
        /* --- MELHORIA: Botão Editar --- */
        body.role-Proprietário .edit-button {
            display: inline-block;
            background-color: var(--button-primary-bg); /* Azul */
            margin-right: 5px;
        }
        body.role-Proprietário .edit-button:hover {
            background-color: var(--button-primary-hover);
        }
        /* --- FIM Botão Editar --- */

        /* Abas */
        .tab-nav {
            background-color: var(--card-bg); /* Editado */
            overflow: hidden;
            border-bottom: 2px solid var(--border-color); /* Editado */
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
            border-radius: 8px 8px 0 0;
        }
        .tab-button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color-light); /* Editado */
            transition: 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button:hover { background-color: var(--bg-color); color: var(--text-color); } /* Editado */
        .tab-button.active {
            color: var(--button-primary-bg); /* Editado */
            font-weight: 600;
            border-bottom: 3px solid var(--button-primary-bg); /* Editado */
        }

        /* Conteúdo das Abas */
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid var(--border-color); /* Editado */
            background-color: var(--card-bg); /* Editado */
            border-top: none;
            border-radius: 0 0 8px 8px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-content.active { display: block; }
        
        h2, h3 {
            color: var(--text-color); /* Editado */
            border-bottom: 2px solid var(--bg-color); /* Editado */
            padding-bottom: 10px;
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Formulários */
        .form-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 15px;
        }
        @media (min-width: 600px) {
            .form-container { grid-template-columns: 1fr 1fr; }
        }
        .form-container-prod {
            grid-template-columns: 1fr;
        }
        @media (min-width: 700px) {
            .form-container-prod {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        .form-container-3col {
            grid-template-columns: 1fr;
        }
        @media (min-width: 700px) {
            .form-container-3col {
                grid-template-columns: 2fr 1fr 1fr;
            }
        }
        .form-container-contagem {
            grid-template-columns: 1fr;
        }
         @media (min-width: 700px) {
            .form-container-contagem {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        /* Container do form de Vendas */
        .form-container-venda {
             grid-template-columns: 1fr;
        }
        @media (min-width: 700px) {
            .form-container-venda {
                /* Data | Prato | Qtd */
                grid-template-columns: 1fr 2fr 1fr;
            }
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-color-light); /* Editado */
        }
        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid var(--input-border); /* Editado */
            border-radius: 6px;
            font-size: 1em;
            background-color: var(--input-bg); /* Editado */
            color: var(--text-color); /* Editado */
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--button-primary-bg); /* Editado */
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Botões */
        .submit-button {
            grid-column: 1 / -1; 
            padding: 12px;
            background-color: var(--button-success-bg); /* Editado */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .submit-button:hover { background-color: var(--button-success-hover); } /* Editado */
        
        .secondary-button {
            padding: 10px 15px;
            background-color: var(--button-primary-bg); /* Editado */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-top: 5px;
        }
        .secondary-button:hover { background-color: var(--button-primary-hover); } /* Editado */

        .copy-button {
            background-color: #9b59b6; /* Roxo */
            font-size: 0.8em;
            padding: 8px 12px;
            margin-left: 10px;
        }
        .copy-button:hover {
            background-color: #8e44ad;
        }
        .copy-button.copied { /* Feedback de cópia */
            background-color: var(--button-success-bg); /* Editado */
        }

        .export-button {
            background-color: #16a085; /* Verde (diferente) */
            font-size: 0.8em;
            padding: 8px 12px;
            margin-left: auto;
        }
        .export-button:hover {
            background-color: #117a65;
        }
        
        /* Botão Cancelar Edição */
        .cancel-edit-button {
            grid-column: 1 / -1;
            background-color: var(--button-warning-bg);
        }
        .cancel-edit-button:hover {
            background-color: var(--button-warning-hover);
        }
        
        /* Nota de aviso (Vendas) */
        .form-nota {
            grid-column: 1 / -1;
            font-size: 0.9em;
            color: var(--text-color-light);
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: 6px;
            margin-top: 0;
        }

        hr { border: 0; border-top: 1px solid var(--border-color); margin: 25px 0; } /* Editado */
        ul { line-height: 1.6; }

        /* Tabela */
        .table-container {
            width: 100%;
            overflow-x: auto; /* Para rolagem em telas pequenas */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid var(--border-color); /* Editado */
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }
        th { background-color: var(--table-header-bg); font-weight: 600; } /* Editado */
        tr:nth-child(even) { background-color: var(--table-row-bg); } /* Editado */
        
        /* ATUALIZAÇÃO: Estilos da Tabela Relatório */
        tr.row-sobra {
            background-color: var(--relatorio-sobra-bg);
        }
        tr.row-falta {
            background-color: var(--relatorio-falta-bg);
        }
        .status-sobra {
            color: var(--relatorio-sobra-text);
            font-weight: bold;
        }
        .status-falta {
            color: var(--relatorio-falta-text);
            font-weight: bold;
        }
        .status-zerado {
            font-weight: bold;
        }
        /* Fim Atualização Relatório */

        tbody:empty::after {
            content: "Carregando dados do Firebase...";
            display: table-cell;
            padding: 15px;
            text-align: center;
            color: var(--text-color-light); /* Editado */
            font-style: italic;
        }
        
        /* Tabela de Resumo */
        .resumo-table td:last-child {
            font-weight: bold;
            font-size: 1.1em;
            text-align: right;
        }
        .resumo-table tr:hover {
            background-color: var(--table-row-hover); /* Editado */
        }

        /* Ingredientes na ficha técnica */
        .ingrediente-item {
            display: grid;
            grid-template-columns: 2fr 1fr auto; /* Coluna auto para o botão */
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px dashed var(--input-border); /* Editado */
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .ingrediente-item button {
            background-color: var(--button-danger-bg); /* Editado */
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            width: 40px; /* Largura fixa para o botão X */
            height: 40px;
        }
        .ingredientes-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
        }
        .ingredientes-list li {
            border-bottom: 1px solid var(--border-color); /* Editado */
            padding: 2px 0;
        }
        .ingredientes-list li:last-child {
            border-bottom: none;
        }
        
        /* Filtro de Relatório e Contagem */
        .filtro-container {
            background-color: var(--table-row-bg); /* Editado */
            border: 1px solid var(--border-color); /* Editado */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: flex-end;
        }
        @media (max-width: 600px) {
            .filtro-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Contêiner para botões da tabela */
        .table-header-buttons {
            display: flex;
            margin-left: auto; /* Joga para a direita */
        }
        
        /* --- MELHORIA: Caixa de Notificação (Substitui alerts) --- */
        #notification-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            background-color: var(--header-bg); /* Editado */
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            /* Começa fora da tela */
            transform: translateX(calc(100% + 30px)); 
            transition: transform 0.4s ease-in-out;
            z-index: 1000;
            max-width: 300px;
            font-weight: 500;
        }
        #notification-box.show {
             /* Move para a tela */
            transform: translateX(0);
        }
        #notification-box.error {
            background-color: var(--button-danger-bg); /* Editado */
        }
    </style>
</head>
<body>

    <!-- HTML da Página -->
    
    <!-- NOVO: Tela de Login (Visível por padrão) -->
    <div id="login-container" class="auth-container">
        <form id="login-form" class="auth-form">
            <h2>Controle de Produção Numar</h2>
            <div class="form-group">
                <label for="login-name">Nome (Login)</label>
                <input type="text" id="login-name" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" required autocomplete="current-password">
            </div>
            <button type="submit">Entrar</button>
            <p id="login-error" class="auth-error"></p>
            <p id="show-register-link" class="auth-link">Não tem conta? Crie uma aqui.</p>
        </form>
    </div>
    
    <!-- NOVO: Tela de Registo (Oculta por padrão) -->
    <div id="register-container" class="auth-container">
        <form id="register-form" class="auth-form">
            <h2>Criar Nova Conta</h2>
            <div class="form-group">
                <label for="register-nome-completo">Seu Nome Completo</label>
                <input type="text" id="register-nome-completo" required class="format-capitalize">
            </div>
            <div class="form-group">
                <label for="register-nome-login">Nome de Login (Ex: vitor)</label>
                <input type="text" id="register-nome-login" required>
            </div>
            <div class="form-group">
                <label for="register-password">Senha (mín. 6 caracteres)</label>
                <input type="password" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="register-funcao">Sua Função</label>
                <select id="register-funcao" required>
                    <option value="">Selecione...</option>
                    <option value="Produção">Produção</option>
                    <option value="Compras">Compras</option>
                </select>
            </div>
            <button type="submit">Registar</button>
            <p id="register-error" class="auth-error"></p>
            <p id="show-login-link" class="auth-link">Já tem conta? Entre aqui.</p>
        </form>
    </div>
    
    <!-- App (Oculto por padrão) -->
    <div id="app-container">
        <header>
            <h1>Controle de Produção Numar</h1>
            <div class="header-info">
                <button id="dark-mode-toggle" title="Alternar modo noturno" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.25rem; margin-right: 10px; line-height: 1;">&#9728;</button>
                <span id="user-name-display"></span>
                <button id="logout-button">Sair</button>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-button" onclick="showTab('itens', this)">Itens</button>
            <button class="tab-button" onclick="showTab('producao', this)">Produção</button>
            <button class="tab-button" onclick="showTab('contagem', this)">Contagem</button>
            <button class="tab-button" onclick="showTab('vendas', this)">Vendas</button>
            <button class="tab-button" onclick="showTab('relatorio', this)">Relatório</button>
        </nav>

        <main>
            <!-- Aba Itens -->
            <div id="itens" class="tab-content">
                <h2>Cadastro de Itens e Categorias</h2>
                <p>Cadastre aqui todos os seus itens. Isso garantirá a padronização em todo o sistema.</p>
                <form id="form-itens" class="form-container">
                    <input type="hidden" id="item-edit-id">
                    <div class="form-group">
                        <label for="item-nome">Nome do Item (Ex: Pescada 200g)</label>
                        <input type="text" id="item-nome" placeholder="Nome único do item" required class="format-capitalize">
                    </div>
                    <div class="form-group">
                        <label for="item-categoria">Categoria</label>
                        <input type="text" id="item-categoria" list="lista-categorias" placeholder="Ex: Proteínas" required class="format-capitalize">
                        <datalist id="lista-categorias">
                            <option value="Proteínas"></option>
                            <option value="Acompanhamentos"></option>
                            <option value="Bebidas"></option>
                            <option value="Descartáveis"></option>
                            <option value="Hortifruti"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Salvar Novo Item</button>
                    </div>
                    <div class="form-group" id="cancel-edit-item-container" style="display: none;">
                        <button type="button" id="cancel-edit-item-btn" class="secondary-button cancel-edit-button">Cancelar Edição</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Itens Cadastrados
                    <button id="export-itens" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Nome do Item</th><th>Categoria</th><th>Ação</th></tr></thead>
                        <tbody id="lista-itens"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Aba Produção -->
            <div id="producao" class="tab-content">
                <h2>Novo Lançamento (Produção)</h2>
                <p>Registre o que foi produzido (a proteína pronta).</p>
                <form id="form-producao" class="form-container form-container-prod">
                    <input type="hidden" id="prod-edit-id">
                    <div class="form-group">
                        <label for="prod-data">Data</label>
                        <input type="date" id="prod-data" required>
                    </div>
                    <div class="form-group">
                        <label for="prod-colaborador">Colaborador</label>
                        <input type="text" id="prod-colaborador" placeholder="Nome" required class="format-capitalize">
                    </div>
                    <div class="form-group">
                        <label for="prod-proteina">Nome da Proteína/Item</label>
                        <select id="prod-proteina" required>
                            <option value="">Selecione um item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prod-peso">Peso Total (kg) (Opcional)</label>
                        <input type="number" id="prod-peso" step="0.001" placeholder="Ex: 10.5">
                    </div>
                    <div class="form-group">
                        <label for="prod-porcao">Porção (g) (Opcional)</label>
                        <input type="number" id="prod-porcao" placeholder="Ex: 200">
                    </div>
                    <div class="form-group">
                        <label for="prod-num-porcoes">Nº de Porções (Obrigatório)</label>
                        <input type="number" id="prod-num-porcoes" placeholder="Ex: 50" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Adicionar Lançamento</button>
                    </div>
                    <div class="form-group" id="cancel-edit-prod-container" style="display: none;">
                        <button type="button" id="cancel-edit-prod-btn" class="secondary-button cancel-edit-button">Cancelar Edição</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Lançamentos de Produção
                    <button id="export-producao" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Colaborador</th><th>Item</th><th>Peso (kg)</th><th>Porção (g)</th><th>Nº Porções</th><th>Ação</th></tr></thead>
                        <tbody id="lista-producao"></tbody>
                    </table>
                </div>
                <hr>
                <h3>Resumo da Produção (Total)</h3>
                <div class="table-container">
                    <table class="resumo-table">
                        <thead><tr><th>Proteína</th><th>Total de Porções Produzidas</th></tr></thead>
                        <tbody id="resumo-producao"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Aba Contagem -->
            <div id="contagem" class="tab-content">
                <h2>Nova Contagem (Estoque Físico)</h2>
                <p>Registre o estoque físico (o que você encontrou na geladeira).</p>
                <form id="form-contagem" class="form-container form-container-contagem">
                    <input type="hidden" id="cont-edit-id">
                    <div class="form-group">
                        <label for="cont-data">Data da Contagem</label>
                        <input type="date" id="cont-data" required>
                    </div>
                    <div class="form-group">
                        <label for="cont-local">Local (Opcional)</label>
                        <input type="text" id="cont-local" placeholder="Ex: Geladeira 1" class="format-capitalize">
                    </div>
                    <div class="form-group">
                        <label for="cont-proteina">Nome do Item</label>
                        <select id="cont-proteina" required>
                            <option value="">Selecione um item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cont-unidade">Unidade</label>
                        <input type="text" id="cont-unidade" list="lista-unidades" value="Porções" required class="format-capitalize">
                        <datalist id="lista-unidades">
                            <option value="Porções"></option><option value="Peças"></option><option value="Kg"></option><option value="Unidades"></option><option value="Pacotes"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="cont-quantidade">Quantidade Contada</label>
                        <input type="number" id="cont-quantidade" min="0" placeholder="Ex: 50" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Salvar Contagem</button>
                    </div>
                    <div class="form-group" id="cancel-edit-cont-container" style="display: none;">
                        <button type="button" id="cancel-edit-cont-btn" class="secondary-button cancel-edit-button">Cancelar Edição</button>
                    </div>
                </form>
                <hr>
                <div class="filtro-container">
                    <div class="form-group">
                        <label for="cont-filtro-data-inicio">De:</label>
                        <input type="date" id="cont-filtro-data-inicio">
                    </div>
                    <div class="form-group">
                        <label for="cont-filtro-data-fim">Até:</label>
                        <input type="date" id="cont-filtro-data-fim">
                    </div>
                    <div class="form-group">
                        <button id="cont-filtro-btn" class="secondary-button" style="width: 100%; padding: 12px;">Filtrar Tabela</button>
                    </div>
                </div>
                <h3>
                    Contagens Salvas (Filtrado)
                    <div class="table-header-buttons">
                        <button id="copiar-contagem-btn" class="secondary-button copy-button">Copiar Contagem</button>
                        <button id="export-contagem" class="secondary-button export-button">Exportar (CSV)</button>
                    </div>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Local</th><th>Item</th><th>Categoria</th><th>Quantidade</th><th>Unidade</th><th>Ação</th></tr></thead>
                        <tbody id="lista-contagem"></tbody>
                    </table>
                </div>
            </div>

            <!-- Aba Vendas -->
            <div id="vendas" class="tab-content">
                <h2>Vendas</h2>
                <h3>Registrar Prato (Ficha Técnica)</h3>
                <p>Crie a "Ficha Técnica" de um prato. Use os itens cadastrados na Produção.</p>
                <form id="form-ficha">
                    <input type="hidden" id="ficha-edit-id">
                    <div class="form-container" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="ficha-nome-prato">Nome do Prato</label>
                            <input type="text" id="ficha-nome-prato" placeholder="Ex: X-Tudo" required class="format-capitalize">
                        </div>
                        <div class="form-group">
                            <label for="ficha-tipo-prato">Tipo de Prato</label>
                            <input type="text" id="ficha-tipo-prato" list="lista-tipos-prato" placeholder="Ex: Individual" required class="format-capitalize">
                            <datalist id="lista-tipos-prato">
                                <option value="Individual"></option>
                                <option value="Executivo"></option>
                                <option value="Compartilhado"></option>
                                <option value="Evento"></option>
                                <option value="Outro"></option>
                            </datalist>
                        </div>
                    </div>
                    <h4>Ingredientes (Itens da Produção)</h4>
                    <div id="ingredientes-container"></div>
                    <div class="form-group">
                        <button type="button" id="add-ingrediente-btn" class="secondary-button">+ Adicionar Item</button>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="submit-button">Salvar Ficha Técnica</button>
                    </div>
                    <div class="form-group" id="cancel-edit-ficha-container" style="display: none;">
                        <button type="button" id="cancel-edit-ficha-btn" class="secondary-button cancel-edit-button">Cancelar Edição</button>
                    </div>
                </form>
                <hr>
                <h3>
                    Fichas Técnicas Salvas
                    <button id="export-fichas" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Colaborador</th><th>Nome do Prato</th><th>Tipo</th><th>Ingredientes (Item | Qtd. Porções)</th><th>Ação</th></tr></thead>
                        <tbody id="lista-fichas"></tbody>
                    </table>
                </div>
                <hr>
                <h3>Registrar Venda</h3>
                <p>Registre a venda de um prato já cadastrado na Ficha Técnica.</p>
                <form id="form-venda" class="form-container form-container-venda">
                    <input type="hidden" id="venda-edit-id">
                    <!-- ID de Lote removido -->
                    <div class="form-group">
                        <label for="venda-data">Data da Venda</label>
                        <input type="date" id="venda-data" required>
                    </div>
                    <div class="form-group">
                        <label for="venda-prato">Selecione o Prato</label>
                        <select id="venda-prato" required><option value="">Carregando pratos...</option></select>
                    </div>
                    <div class="form-group">
                        <label for="venda-quantidade">Quantidade Vendida (Total)</label>
                        <input type="number" id="venda-quantidade" min="1" value="1" required>
                    </div>
                    
                    <!-- Checkbox de Venda Semanal REMOVIDO -->

                    <div class="form-group">
                        <button type="submit" class="submit-button">Registrar Venda</button>
                    </div>
                    <div class="form-group" id="cancel-edit-venda-container" style="display: none;">
                        <button type="button" id="cancel-edit-venda-btn" class="secondary-button cancel-edit-button">Cancelar Edição</button>
                    </div>
                    
                    <!-- NOTA de Aviso -->
                    <p class="form-nota">
                        <strong>Nota:</strong> Para balanço semanal (PDV), lance o total de vendas da semana em um único dia (ex: Domingo). O Relatório funcionará corretamente ao filtrar pela semana inteira.
                    </p>
                </form>
                
                <hr>
                <h3>
                    Vendas Registradas
                    <button id="export-vendas" class="secondary-button export-button">Exportar (CSV)</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Colaborador</th><th>Prato Vendido</th><th>Quantidade</th><th>Ação</th></tr></thead>
                        <tbody id="lista-vendas"></tbody>
                    </table>
                </div>
                
                <!-- ATUALIZAÇÃO: Resumo de Vendas -->
                <hr>
                <h3>Resumo de Vendas (Total de Pratos)</h3>
                <div class="table-container">
                    <table class="resumo-table">
                        <thead><tr><th>Prato</th><th>Total de Pratos Vendidos</th></tr></thead>
                        <tbody id="resumo-vendas"></tbody>
                    </table>
                </div>
            </div>

            <!-- Aba Relatório -->
            <div id="relatorio" class="tab-content">
                <h2>
                    Relatório (Balanço de Estoque)
                    <button id="export-relatorio" class="secondary-button export-button">Exportar (CSV)</button>
                </h2>
                <p>Comparativo do estoque físico (Contado) vs. estoque teórico (Sistema). Apenas contagens em "Porções" são usadas no balanço.</p>
                <div class="filtro-container">
                    <div class="form-group">
                        <label for="filtro-data-inicio">Data Inicial</label>
                        <input type="date" id="filtro-data-inicio">
                    </div>
                    <div class="form-group">
                        <label for="filtro-data-fim">Data Final</label>
                        <input type="date" id="filtro-data-fim">
                    </div>
                    <div class="form-group">
                        <button id="filtro-relatorio-btn" class="secondary-button" style="width: 100%; padding: 12px;">Gerar Relatório</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Item</th><th>Est. Inicial (Contado)</th><th>Produzido (Entrada)</th><th>Vendido (Saída)</th><th>Est. Teórico (Final)</th><th>Est. Físico (Final)</th><th>Diferença (Sobra / Falta)</th></tr></thead>
                        <tbody id="lista-relatorio"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- MELHORIA: Caixa de Notificação para substituir os 'alerts' -->
    <div id="notification-box"></div>

    <!-- SDKs do Firebase e Lógica do App -->
    <script type="module">
        // Importa os módulos necessários
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, 
            signInWithEmailAndPassword, signOut, onAuthStateChanged,
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, onSnapshot, 
            deleteDoc, query, where, writeBatch, setLogLevel,
            getDoc, setDoc, updateDoc, getDocs // Adicionado getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase (Modo Produção) ---
        
        // !!! IMPORTANTE !!!
        // COLE A SUA CONFIGURAÇÃO DO FIREBASE AQUI
        // (Substitua este bloco de exemplo)
         const firebaseConfig = {

  apiKey: "AIzaSyA8dGdSRGDtgNVgnI5vmpxsIKdjkhWAnTo",

  authDomain: "numartestefinal.firebaseapp.com",

  projectId: "numartestefinal",

  storageBucket: "numartestefinal.firebasestorage.app",

  messagingSenderId: "97213975077",

  appId: "1:97213975077:web:f917ed086a26d378f90dcc"
};


        // Use o AppID da configuração
        const appId = firebaseConfig.appId;
        // --- Fim da Configuração ---
        
        // --- VARIÁVEIS GLOBAIS ---
        let app, auth, db;
        let userId;
        let userRole = null; 
        let currentUserName = null; // ATUALIZAÇÃO: Nome do usuário
        
        let listeners = [];
        
        // Caches locais
        let itensDB = [];
        let producaoDB = [];
        let contagemDB = [];
        let fichasDB = [];
        let vendasDB = [];
        
        // Referências das Coleções do Firestore
        let itensCol, producaoCol, contagemCol, fichasCol, vendasCol, userRolesCol;
        
        let relatorioCache = []; 

        // --- Variáveis do DOM (declaradas globalmente) ---
        let loginContainer, appContainer, loginForm, loginName, loginPassword, loginError, showRegisterLink;
        let registerContainer, registerForm, registerNomeCompleto, registerNomeLogin, registerPassword, registerFuncao, registerError, showLoginLink;
        let logoutButton, userNameDisplay, formItens, listaItens, itemNome, itemCategoria, formProducao, listaProducao;
        let prodData, prodColaborador, prodProteina, prodPeso, prodPorcao, prodNumPorcoes, resumoProducao;
        let formContagem, listaContagem, contData, contLocal, contProteina, contUnidade, contQuantidade;
        let copiarContagemBtn, contFiltroDataInicio, contFiltroDataFim, contFiltroBtn;
        let formFicha, listaFichas, fichaNomePrato, fichaTipoPrato, addIngredienteBtn, ingredientesContainer;
        let formVenda, listaVendas, vendaData, vendaPratoSelect, vendaQuantidade, resumoVendas; // 'vendaSemanal' removido
        let filtroDataInicio, filtroDataFim, filtroRelatorioBtn, listaRelatorio;
        let darkModeToggle, notificationBox;
        
        // --- MELHORIA: Variáveis de Edição ---
        let itemEditId, itemSubmitButton, cancelEditItemBtn, cancelEditItemContainer;
        let prodEditId, prodSubmitButton, cancelEditProdBtn, cancelEditProdContainer;
        let contEditId, contSubmitButton, cancelEditContBtn, cancelEditContContainer;
        let fichaEditId, fichaSubmitButton, cancelEditFichaBtn, cancelEditFichaContainer;
        let vendaEditId, vendaSubmitButton, cancelEditVendaBtn, cancelEditVendaContainer; // 'vendaBatchId' removido
        
        // --- MELHORIA: Elemento e Lógica de Notificação ---
        let notificationTimer;
        let itensCarregados = false; // Flag para Ficha Técnica

        /**
         * Mostra uma notificação não-bloqueante na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {boolean} [isError=false] - Define se é uma notificação de erro (vermelha).
         */
        function showNotification(message, isError = false) {
            if (!notificationBox) {
                notificationBox = document.getElementById('notification-box');
                if (!notificationBox) return; // Sai se ainda não existe
            }
            
            clearTimeout(notificationTimer); // Limpa timer anterior
            
            notificationBox.textContent = message;
            notificationBox.classList.add('show');
            
            if (isError) {
                notificationBox.classList.add('error');
            } else {
                notificationBox.classList.remove('error');
            }

            notificationTimer = setTimeout(() => {
                notificationBox.classList.remove('show');
            }, 3000);
        }

        // --- ATUALIZAÇÃO: Função de Formatação de Texto (CORRIGIDA) ---
        function capitalizeWords(str) {
            if (!str) return '';
            try {
                // Tenta usar o regex com Unicode
                return str.toLowerCase().replace(/(^|\s)\p{L}/gu, (char) => char.toUpperCase());
            } catch (e) {
                // Fallback para navegadores antigos (sem \p{L})
                console.warn("Regex Unicode (\\p{L}) não suportado. Usando fallback.");
                return str.toLowerCase().replace(/(^|\s)[a-z]/g, (char) => char.toUpperCase());
            }
        }

        // --- FUNÇÕES DE INICIALIZAÇÃO E DADOS ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                // --- INÍCIO DO CÓDIGO DE LOGIN REAL (PRODUÇÃO) ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Utilizador logado:", userId);
                        
                        // Define os caminhos das coleções (Modo Produção)
                        // Caminho público para dados compartilhados
                        const dataPath = `artifacts/${appId}/public/data`;
                        itensCol = collection(db, `${dataPath}/itens`);
                        producaoCol = collection(db, `${dataPath}/producao`);
                        contagemCol = collection(db, `${dataPath}/contagem`);
                        fichasCol = collection(db, `${dataPath}/fichas`);
                        vendasCol = collection(db, `${dataPath}/vendas`);
                        // Coleção separada para roles (geralmente na raiz ou caminho específico)
                        userRolesCol = collection(db, `user-roles`); 

                        const userRoleDoc = await getDoc(doc(userRolesCol, userId));
                        
                        if (userRoleDoc.exists()) {
                            const userData = userRoleDoc.data();
                            userRole = userData.funcao; 
                            currentUserName = userData.nome || 'Utilizador'; // ATUALIZAÇÃO
                            userNameDisplay.textContent = `Olá, ${currentUserName}`; // ATUALIZAÇÃO
                            
                            setupUIForRole(userRole);
                            carregarDadosListeners();
                            
                            appContainer.style.display = 'block';
                            loginContainer.style.display = 'none'; 
                            registerContainer.style.display = 'none'; 
                            loginError.style.display = 'none';
                            registerError.style.display = 'none';

                        } else {
                            // Tenta novamente caso o registro tenha acabado de acontecer
                            console.error("Utilizador sem função (role) definida. Tentando novamente em 1.5s...");
                            setTimeout(async () => {
                                const retryDoc = await getDoc(doc(userRolesCol, userId));
                                if (retryDoc.exists()) {
                                    const userData = retryDoc.data();
                                    userRole = userData.funcao; 
                                    currentUserName = userData.nome || 'Utilizador'; // ATUALIZAÇÃO
                                    userNameDisplay.textContent = `Olá, ${currentUserName}`; // ATUALIZAÇÃO
                                    setupUIForRole(userRole);
                                    carregarDadosListeners();
                                    appContainer.style.display = 'block';
                                    loginContainer.style.display = 'none';
                                    registerContainer.style.display = 'none';
                                } else {
                                    // Falha real
                                    showNotification("Erro: A sua conta não tem permissões. Contacte o admin.", true);
                                    await signOut(auth);
                                }
                            }, 1500);
                        }
                        
                    } else {
                        // --- UTILIZADOR ESTÁ DESLOGADO ---
                        console.log("Utilizador deslogado.");
                        userId = null;
                        userRole = null;
                        currentUserName = null; // ATUALIZAÇÃO
                        
                        listeners.forEach(unsubscribe => unsubscribe());
                        listeners = [];
                        
                        itensDB = [], producaoDB = [], contagemDB = [], fichasDB = [], vendasDB = [];
                        
                        appContainer.style.display = 'none';
                        loginContainer.style.display = 'flex'; // Mostra login
                        registerContainer.style.display = 'none'; // Esconde registo
                        userNameDisplay.textContent = '';
                        document.body.className = ''; 
                    }
                });
                // --- FIM DO CÓDIGO DE LOGIN REAL ---
                

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                if (firebaseConfig.apiKey === "COLE-SUA-API-KEY-AQUI") {
                     alert("ERRO: Você não colou sua 'firebaseConfig' no arquivo de produção!");
                } else {
                   alert("Erro fatal ao conectar com Firebase: " + error.message);
                }
            }
        }
        
        function setupUIForRole(role) {
            document.body.className = `role-${role}`;
             if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            
            const tabItens = document.querySelector('[onclick*="itens"]');
            const tabProducao = document.querySelector('[onclick*="producao"]');
            const tabContagem = document.querySelector('[onclick*="contagem"]');
            const tabVendas = document.querySelector('[onclick*="vendas"]');
            const tabRelatorio = document.querySelector('[onclick*="relatorio"]');

            [tabItens, tabProducao, tabContagem, tabVendas, tabRelatorio].forEach(tab => {
                if(tab) tab.classList.add('tab-hidden');
            });

            switch (role) {
                case "Proprietário":
                    [tabItens, tabProducao, tabContagem, tabVendas, tabRelatorio].forEach(tab => {
                        if(tab) tab.classList.remove('tab-hidden');
                    });
                    showTab('itens', tabItens);
                    break;
                case "Produção":
                    [tabItens, tabProducao, tabContagem].forEach(tab => {
                        if(tab) tab.classList.remove('tab-hidden');
                    });
                    showTab('itens', tabItens);
                    break;
                case "Compras":
                    [tabVendas, tabRelatorio].forEach(tab => {
                        if(tab) tab.classList.remove('tab-hidden');
                    });
                    showTab('vendas', tabVendas);
                    break;
                default:
                    console.warn("Função desconhecida:", role);
                    // Esconde tudo se a função for inválida
                    showTab('', null);
                    break;
            }
        }

        function carregarDadosListeners() {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            itensCarregados = false; // Reseta a flag
            let fichasCarregadas = false;

            function checkInitialLoad() {
                if (itensCarregados && fichasCarregadas) {
                    if (ingredientesContainer.children.length === 0) {
                        adicionarCampoIngrediente();
                    }
                }
            }

            listeners.push(onSnapshot(itensCol, (snapshot) => {
                itensDB = [];
                snapshot.forEach(doc => {
                    itensDB.push({ ...doc.data(), id: doc.id }); 
                });
                console.log("Itens carregados:", itensDB.length);
                itensCarregados = true; // Define a flag
                renderizarTabelaItens();
                atualizarDropdownsItens(); 
                checkInitialLoad();
            }, (error) => console.error("Erro ao carregar itens:", error)));
            
            listeners.push(onSnapshot(producaoCol, (snapshot) => {
                producaoDB = [];
                snapshot.forEach(doc => {
                    producaoDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Produção carregada:", producaoDB.length);
                renderizarTabelaProducao();
                renderizarResumoProducao();
            }, (error) => console.error("Erro ao carregar produção:", error)));

            listeners.push(onSnapshot(contagemCol, (snapshot) => {
                contagemDB = [];
                snapshot.forEach(doc => {
                    contagemDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Contagem carregada:", contagemDB.length);
                renderizarTabelaContagem(true); 
            }, (error) => console.error("Erro ao carregar contagem:", error)));
            
            listeners.push(onSnapshot(fichasCol, (snapshot) => {
                fichasDB = [];
                snapshot.forEach(doc => {
                    fichasDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Fichas carregadas:", fichasDB.length);
                fichasCarregadas = true;
                renderizarTabelaFichas();
                atualizarSelectPratosVenda(); 
                checkInitialLoad();
            }, (error) => console.error("Erro ao carregar fichas:", error)));
            
            listeners.push(onSnapshot(vendasCol, (snapshot) => {
                vendasDB = [];
                snapshot.forEach(doc => {
                    vendasDB.push({ ...doc.data(), id: doc.id });
                });
                console.log("Vendas carregadas:", vendasDB.length);
                renderizarTabelaVendas();
                renderizarResumoVendas(); // ATUALIZAÇÃO
            }, (error) => console.error("Erro ao carregar vendas:", error)));
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO (VISUAL) ---
        
        function renderizarTabelaItens() {
            listaItens.innerHTML = '';
            itensDB.sort((a,b) => a.nome.localeCompare(b.nome));
            itensDB.forEach(item => {
                const tr = document.createElement('tr');
                const safeNome = (item.nome || '').replace(/'/g, "\\'");
                const safeCategoria = (item.categoria || '').replace(/'/g, "\\'");
                tr.innerHTML = `
                    <td>${item.nome}</td>
                    <td>${item.categoria}</td>
                    <td style="min-width: 140px;">
                        <button class="action-button edit-button" onclick="editarItemItem('${item.id}', '${safeNome}', '${safeCategoria}')">
                            Editar
                        </button>
                        <button class="action-button" onclick="excluirItemItem('${item.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaItens.appendChild(tr);
            });
        }
        
        function atualizarDropdownsItens() {
            let options = '<option value="">Selecione um item...</option>';
            itensDB.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                options += `<option value="${item.nome}">${item.nome}</option>`;
            });
            
            if(prodProteina) prodProteina.innerHTML = options;
            if(contProteina) contProteina.innerHTML = options;
            
            if(ingredientesContainer) {
                const selectsFicha = ingredientesContainer.querySelectorAll('.ficha-ingrediente-proteina');
                selectsFicha.forEach(select => {
                    const valorAntigo = select.value;
                    select.innerHTML = options;
                    select.value = valorAntigo; 
                });
            }
        }

        function renderizarTabelaProducao() {
            listaProducao.innerHTML = ''; 
            producaoDB.sort((a,b) => b.data.localeCompare(a.data)); 
            producaoDB.forEach(item => {
                const tr = document.createElement('tr');
                const safeColab = (item.colaborador || '').replace(/'/g, "\\'");
                const safeProt = (item.proteina || '').replace(/'/g, "\\'");
                
                tr.innerHTML = `
                    <td>${formatarData(item.data)}</td>
                    <td>${item.colaborador}</td>
                    <td>${item.proteina}</td>
                    <td>${item.pesoKg || '-'} kg</td>
                    <td>${item.porcaoGramas || '-'} g</td>
                    <td>${item.numPorcoes}</td>
                    <td style="min-width: 140px;">
                        <button class="action-button edit-button" 
                            onclick="editarItemProducao('${item.id}', '${item.data}', '${safeColab}', '${safeProt}', '${item.pesoKg || ''}', '${item.porcaoGramas || ''}', '${item.numPorcoes}')">
                            Editar
                        </button>
                        <button class="action-button" onclick="excluirItemProducao('${item.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaProducao.appendChild(tr);
            });
        }
        
        function renderizarResumoProducao() {
            if (!resumoProducao) return;
            resumoProducao.innerHTML = '';
            const totais = {};
            producaoDB.forEach(item => {
                const porcoes = item.numPorcoes || 0;
                totais[item.proteina] = (totais[item.proteina] || 0) + porcoes;
            });
            const proteinasOrdenadas = Object.keys(totais).sort();
            proteinasOrdenadas.forEach(proteina => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${proteina}</strong></td>
                    <td>${totais[proteina]} porções</td>
                `;
                resumoProducao.appendChild(tr);
            });
        }
        
        function renderizarTabelaContagem(usarFiltro = false) {
            if (!listaContagem) return;
            listaContagem.innerHTML = '';
            let dataInicio = '1970-01-01';
            let dataFim = '2099-12-31';
            if (usarFiltro) {
                 dataInicio = contFiltroDataInicio.value || '1970-01-01';
                 dataFim = contFiltroDataFim.value || '2099-12-31';
            }
            
            const contagensFiltradas = contagemDB
                .filter(item => item.data >= dataInicio && item.data <= dataFim)
                .sort((a,b) => b.data.localeCompare(a.data));

            contagensFiltradas.forEach(item => {
                const itemInfo = itensDB.find(i => i.nome === item.proteina);
                const categoria = (itemInfo && itemInfo.categoria) ? itemInfo.categoria : 'Sem Categoria';
                const tr = document.createElement('tr');
                
                const safeLocal = (item.local || '').replace(/'/g, "\\'");
                const safeProt = (item.proteina || '').replace(/'/g, "\\'");
                const safeUni = (item.unidade || '').replace(/'/g, "\\'");

                tr.innerHTML = `
                    <td>${formatarData(item.data)}</td>
                    <td>${item.local || '-'}</td>
                    <td>${item.proteina}</td>
                    <td>${categoria}</td>
                    <td>${item.quantidade}</td>
                    <td>${item.unidade}</td>
                    <td style="min-width: 140px;">
                        <button class="action-button edit-button"
                            onclick="editarItemContagem('${item.id}', '${item.data}', '${safeLocal}', '${safeProt}', '${item.quantidade}', '${safeUni}')">
                            Editar
                        </button>
                        <button class="action-button" onclick="excluirItemContagem('${item.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaContagem.appendChild(tr);
            });
        }
        
        function renderizarTabelaFichas() {
            if (!listaFichas) return;
            listaFichas.innerHTML = '';
            fichasDB.forEach(ficha => {
                const tr = document.createElement('tr');
                const ingredientesHtml = (ficha.ingredientes || []).map(ing => {
                    return `<li class="ingredientes-list-item">
                                <strong>${ing.proteina}:</strong> ${ing.qtdPorcoes} porção(ões)
                            </li>`;
                }).join('');
                
                const safeNome = (ficha.nomePrato || '').replace(/'/g, "\\'");
                
                tr.innerHTML = `
                    <td>${ficha.colaborador || 'N/A'}</td> <!-- COLABORADOR -->
                    <td>${ficha.nomePrato}</td>
                    <td>${ficha.tipoPrato}</td>
                    <td><ul class="ingredientes-list">${ingredientesHtml}</ul></td>
                    <td style="min-width: 140px;">
                         <button class="action-button edit-button"
                            onclick="editarItemFicha('${ficha.id}')">
                            Editar
                        </button>
                        <button class="action-button" onclick="excluirItemFicha('${ficha.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaFichas.appendChild(tr);
            });
        }
        
        function renderizarTabelaVendas() {
            if (!listaVendas) return;
            listaVendas.innerHTML = '';
            vendasDB.sort((a,b) => b.data.localeCompare(a.data)); 
            vendasDB.forEach(venda => {
                const tr = document.createElement('tr');
                const safePrato = (venda.nomePrato || '').replace(/'/g, "\\'");
                
                // Botão de editar está sempre ativo agora
                tr.innerHTML = `
                    <td>${formatarData(venda.data)}</td>
                    <td>${venda.colaborador || 'N/A'}</td> <!-- COLABORADOR -->
                    <td>${venda.nomePrato}</td>
                    <td>${venda.quantidade}</td>
                    <td style="min-width: 140px;">
                        <button class="action-button edit-button"
                            onclick="editarItemVenda('${venda.id}', '${venda.data}', '${safePrato}', '${venda.quantidade}')">
                            Editar
                        </button>
                        <button class="action-button" onclick="excluirItemVenda('${venda.id}')">
                            Excluir
                        </button>
                    </td>
                `;
                listaVendas.appendChild(tr);
            });
        }
        
        // ATUALIZAÇÃO: Resumo de Vendas
        function renderizarResumoVendas() {
            if (!resumoVendas) return;
            resumoVendas.innerHTML = '';
            const totais = {};
            vendasDB.forEach(item => {
                const qtd = item.quantidade || 0;
                totais[item.nomePrato] = (totais[item.nomePrato] || 0) + qtd;
            });
            const pratosOrdenados = Object.keys(totais).sort();
            pratosOrdenados.forEach(prato => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${prato}</strong></td>
                    <td>${totais[prato]} pratos</td>
                `;
                resumoVendas.appendChild(tr);
            });
        }

        function criarSelectProteinasHTML() {
            let options = '<option value="">Selecione o Item...</option>';
            itensDB.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                options += `<option value="${item.nome}">${item.nome}</option>`;
            });
            return `<select class="ficha-ingrediente-proteina" required>${options}</select>`;
        }
        
        function atualizarSelectPratosVenda() {
            if (!vendaPratoSelect) return;
            const valorAntigo = vendaPratoSelect.value;
            vendaPratoSelect.innerHTML = '<option value="">Selecione um prato</option>';
            const nomesPratos = [...new Set(fichasDB.map(ficha => ficha.nomePrato))].sort();
            nomesPratos.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;
                vendaPratoSelect.appendChild(option);
            });
            vendaPratoSelect.value = valorAntigo;
        }

        // --- LÓGICA DE EVENTOS ---

        // --- Funções Globais (para onclick) ---
        
        window.removerCampoIngrediente = (botao) => {
            if (ingredientesContainer.children.length > 1) {
                botao.parentElement.remove();
            } else {
                showNotification("A ficha deve ter pelo menos um ingrediente.", true);
            }
        }

        window.excluirItemItem = async (docId) => {
            if (userRole !== 'Proprietário') return; 
            const item = itensDB.find(i => i.id === docId);
            if (!item) return;
            const itemNome = item.nome;
            const emUsoProducao = producaoDB.some(p => p.proteina === itemNome);
            const emUsoContagem = contagemDB.some(c => c.proteina === itemNome);
            const emUsoFicha = fichasDB.some(f => f.ingredientes.some(i => i.proteina === itemNome));
            if (emUsoProducao || emUsoContagem || emUsoFicha) {
                return showNotification("Não é possível excluir este item, pois ele já está sendo usado.", true);
            }
            try {
                await deleteDoc(doc(itensCol, docId));
                showNotification("Item excluído.");
                resetItemForm();
            } catch (error) {
                console.error("Erro ao excluir item:", error);
                showNotification("Erro ao excluir item.", true);
            }
        }

        window.excluirItemProducao = async (docId) => {
            if (userRole !== 'Proprietário') return;
            try {
                await deleteDoc(doc(producaoCol, docId));
                showNotification("Lançamento de produção excluído.");
                resetProducaoForm();
            } catch (error) {
                console.error("Erro ao excluir produção:", error);
                showNotification("Erro ao excluir produção.", true);
            }
        }
        
        window.excluirItemContagem = async (docId) => {
            if (userRole !== 'Proprietário') return;
            try {
                await deleteDoc(doc(contagemCol, docId));
                showNotification("Contagem excluída.");
                resetContagemForm();
            } catch (error) {
                console.error("Erro ao excluir contagem:", error);
                showNotification("Erro ao excluir contagem.", true);
            }
        }

        window.excluirItemFicha = async (docId) => {
            if (userRole !== 'Proprietário') return;
             const ficha = fichasDB.find(f => f.id === docId);
             if (ficha && vendasDB.some(v => v.nomePrato === ficha.nomePrato)) {
                 return showNotification("Não é possível excluir esta ficha, pois ela já foi usada em vendas.", true);
             }
            try {
                await deleteDoc(doc(fichasCol, docId));
                showNotification("Ficha técnica excluída.");
                resetFichaForm();
            } catch (error) {
                console.error("Erro ao excluir ficha:", error);
                showNotification("Erro ao excluir ficha.", true);
            }
        }
        
        // ATUALIZAÇÃO: Lógica de exclusão simplificada
        window.excluirItemVenda = async (docId) => {
            if (userRole !== 'Proprietário') return;
            
            try {
                await deleteDoc(doc(vendasCol, docId));
                showNotification("Venda excluída.");
                resetVendaForm();
            } catch (error) {
                console.error("Erro ao excluir venda:", error);
                showNotification("Erro ao excluir venda.", true);
            }
        }

        // --- TROCA DE ABAS (Navegação) ---
        window.showTab = (tabId, clickedButton) => {
            let allContent = document.querySelectorAll('.tab-content');
            allContent.forEach(content => content.classList.remove('active'));
            let allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(button => button.classList.remove('active'));
            
            const tabToShow = document.getElementById(tabId);
            if(tabToShow) {
                tabToShow.classList.add('active');
            }
            
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // CORREÇÃO: Só adiciona ingrediente se os itens estiverem carregados
            if (tabId === 'vendas' && ingredientesContainer.children.length === 0 && itensCarregados) {
                adicionarCampoIngrediente(); 
            }
            if (tabId === 'relatorio') {
                calcularRelatorioBalanço(filtroDataInicio.value, filtroDataFim.value);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Atribuição das variáveis do DOM ---
            loginContainer = document.getElementById('login-container');
            appContainer = document.getElementById('app-container');
            loginForm = document.getElementById('login-form');
            loginName = document.getElementById('login-name');
            loginPassword = document.getElementById('login-password');
            loginError = document.getElementById('login-error');
            showRegisterLink = document.getElementById('show-register-link');
            registerContainer = document.getElementById('register-container');
            registerForm = document.getElementById('register-form');
            registerNomeCompleto = document.getElementById('register-nome-completo');
            registerNomeLogin = document.getElementById('register-nome-login');
            registerPassword = document.getElementById('register-password');
            registerFuncao = document.getElementById('register-funcao');
            registerError = document.getElementById('register-error');
            showLoginLink = document.getElementById('show-login-link');
            logoutButton = document.getElementById('logout-button');
            userNameDisplay = document.getElementById('user-name-display');
            darkModeToggle = document.getElementById('dark-mode-toggle');
            notificationBox = document.getElementById('notification-box');

            // Aba Itens
            formItens = document.getElementById('form-itens');
            listaItens = document.getElementById('lista-itens');
            itemNome = document.getElementById('item-nome');
            itemCategoria = document.getElementById('item-categoria');
            itemEditId = document.getElementById('item-edit-id');
            itemSubmitButton = document.querySelector('#form-itens .submit-button');
            cancelEditItemBtn = document.getElementById('cancel-edit-item-btn');
            cancelEditItemContainer = document.getElementById('cancel-edit-item-container');

            // Aba Produção
            formProducao = document.getElementById('form-producao');
            listaProducao = document.getElementById('lista-producao');
            prodData = document.getElementById('prod-data');
            prodColaborador = document.getElementById('prod-colaborador');
            prodProteina = document.getElementById('prod-proteina');
            prodPeso = document.getElementById('prod-peso');
            prodPorcao = document.getElementById('prod-porcao');
            prodNumPorcoes = document.getElementById('prod-num-porcoes');
            resumoProducao = document.getElementById('resumo-producao');
            prodEditId = document.getElementById('prod-edit-id');
            prodSubmitButton = document.querySelector('#form-producao .submit-button');
            cancelEditProdBtn = document.getElementById('cancel-edit-prod-btn');
            cancelEditProdContainer = document.getElementById('cancel-edit-prod-container');

            // Aba Contagem
            formContagem = document.getElementById('form-contagem');
            listaContagem = document.getElementById('lista-contagem');
            contData = document.getElementById('cont-data');
            contLocal = document.getElementById('cont-local');
            contProteina = document.getElementById('cont-proteina');
            contUnidade = document.getElementById('cont-unidade');
            contQuantidade = document.getElementById('cont-quantidade');
            copiarContagemBtn = document.getElementById('copiar-contagem-btn');
            contFiltroDataInicio = document.getElementById('cont-filtro-data-inicio');
            contFiltroDataFim = document.getElementById('cont-filtro-data-fim');
            contFiltroBtn = document.getElementById('cont-filtro-btn');
            contEditId = document.getElementById('cont-edit-id');
            contSubmitButton = document.querySelector('#form-contagem .submit-button');
            cancelEditContBtn = document.getElementById('cancel-edit-cont-btn');
            cancelEditContContainer = document.getElementById('cancel-edit-cont-container');

            // Aba Vendas (Ficha e Venda)
            formFicha = document.getElementById('form-ficha');
            listaFichas = document.getElementById('lista-fichas');
            fichaNomePrato = document.getElementById('ficha-nome-prato');
            fichaTipoPrato = document.getElementById('ficha-tipo-prato');
            addIngredienteBtn = document.getElementById('add-ingrediente-btn');
            ingredientesContainer = document.getElementById('ingredientes-container');
            formVenda = document.getElementById('form-venda');
            listaVendas = document.getElementById('lista-vendas');
            vendaData = document.getElementById('venda-data');
            vendaPratoSelect = document.getElementById('venda-prato');
            vendaQuantidade = document.getElementById('venda-quantidade');
            // vendaSemanal removido
            resumoVendas = document.getElementById('resumo-vendas');
            fichaEditId = document.getElementById('ficha-edit-id');
            fichaSubmitButton = document.querySelector('#form-ficha .submit-button');
            cancelEditFichaBtn = document.getElementById('cancel-edit-ficha-btn');
            cancelEditFichaContainer = document.getElementById('cancel-edit-ficha-container');
            vendaEditId = document.getElementById('venda-edit-id');
            // vendaBatchId removido
            vendaSubmitButton = document.querySelector('#form-venda .submit-button');
            cancelEditVendaBtn = document.getElementById('cancel-edit-venda-btn');
            cancelEditVendaContainer = document.getElementById('cancel-edit-venda-container');

            // Aba Relatório
            filtroDataInicio = document.getElementById('filtro-data-inicio');
            filtroDataFim = document.getElementById('filtro-data-fim');
            filtroRelatorioBtn = document.getElementById('filtro-relatorio-btn');
            listaRelatorio = document.getElementById('lista-relatorio');
            
            // --- FIM da Atribuição ---

            initFirebase();

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    darkModeToggle.innerHTML = '&#9790;'; // Lua
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    darkModeToggle.innerHTML = '&#9728;'; // Sol
                    localStorage.removeItem('darkMode');
                }
            });
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '&#9790;'; // Lua
            }
            
            const hoje = new Date().toISOString().split('T')[0];
            prodData.value = hoje;
            contData.value = hoje;
            vendaData.value = hoje;
            const dataFim = new Date();
            const dataInicio = new Date();
            dataInicio.setDate(dataFim.getDate() - 6);
            filtroDataInicio.value = dataInicio.toISOString().split('T')[0];
            filtroDataFim.value = dataFim.toISOString().split('T')[0];
            contFiltroDataInicio.value = hoje;
            contFiltroDataFim.value = hoje;
            
            document.getElementById('export-itens').addEventListener('click', exportarItens);
            document.getElementById('export-producao').addEventListener('click', exportarProducao);
            document.getElementById('export-contagem').addEventListener('click', exportarContagem);
            document.getElementById('export-fichas').addEventListener('click', exportarFichas);
            document.getElementById('export-vendas').addEventListener('click', exportarVendas);
            document.getElementById('export-relatorio').addEventListener('click', exportarRelatorio);
            
            filtroRelatorioBtn.addEventListener('click', () => {
                calcularRelatorioBalanço(filtroDataInicio.value, filtroDataFim.value);
            });
            contFiltroBtn.addEventListener('click', () => renderizarTabelaContagem(true));
            copiarContagemBtn.addEventListener('click', copiarContagemFormatada);
            
            
            cancelEditItemBtn.addEventListener('click', resetItemForm);
            cancelEditProdBtn.addEventListener('click', resetProducaoForm);
            cancelEditContBtn.addEventListener('click', resetContagemForm);
            cancelEditFichaBtn.addEventListener('click', resetFichaForm);
            cancelEditVendaBtn.addEventListener('click', resetVendaForm);

            document.addEventListener('blur', (e) => {
                if (e.target && e.target.classList.contains('format-capitalize')) {
                    e.target.value = capitalizeWords(e.target.value);
                }
            }, true); 

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = loginName.value.trim();
                const email = `${name.toLowerCase()}@numar.app`; 
                const password = loginPassword.value;
                loginError.style.display = 'none';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Erro ao fazer login:", error.code);
                    loginError.textContent = "Login ou senha inválidos.";
                    loginError.style.display = 'block';
                }
            });
            
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                }
            });
            
            showRegisterLink.addEventListener('click', () => {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'flex';
            });
            showLoginLink.addEventListener('click', () => {
                loginContainer.style.display = 'flex';
                registerContainer.style.display = 'none';
            });
            
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nomeCompleto = capitalizeWords(registerNomeCompleto.value.trim());
                const nomeLogin = registerNomeLogin.value.trim();
                const password = registerPassword.value;
                const funcao = registerFuncao.value;
                registerError.style.display = 'none';

                if (!nomeCompleto || !nomeLogin || !password || !funcao) {
                    registerError.textContent = "Preencha todos os campos.";
                    registerError.style.display = 'block';
                    return;
                }
                if (funcao === "Proprietário") {
                    registerError.textContent = "Função inválida.";
                    registerError.style.display = 'block';
                    return;
                }
                
                const email = `${nomeLogin.toLowerCase()}@numar.app`;
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    userRolesCol = collection(db, `user-roles`); 
                    await setDoc(doc(userRolesCol, user.uid), {
                        nome: nomeCompleto,
                        funcao: funcao
                    });
                } catch (error) {
                    console.error("Erro ao registar:", error.code);
                    if (error.code === 'auth/email-already-in-use') {
                        registerError.textContent = "Este Nome de Login já está em uso.";
                    } else if (error.code === 'auth/weak-password') {
                        registerError.textContent = "A senha deve ter pelo menos 6 caracteres.";
                    } else {
                        registerError.textContent = "Erro ao criar conta.";
                    }
                    registerError.style.display = 'block';
                }
            });

            // --- Formulário Itens (Criar/Editar) ---
            formItens.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = capitalizeWords(itemNome.value.trim());
                const categoria = capitalizeWords(itemCategoria.value.trim());
                const docId = itemEditId.value; 
                
                if (!nome || !categoria) return showNotification("Preencha Nome e Categoria.", true);
                
                try {
                    if (docId) {
                        if (itensDB.some(item => item.nome.toLowerCase() === nome.toLowerCase() && item.id !== docId)) {
                             return showNotification("Este nome de item já pertence a outro item.", true);
                        }
                        const itemRef = doc(itensCol, docId);
                        await updateDoc(itemRef, { nome, categoria }); 
                        showNotification('Item atualizado com sucesso!');
                    } else {
                        if (itensDB.some(item => item.nome.toLowerCase() === nome.toLowerCase())) {
                            return showNotification("Este nome de item já existe.", true);
                        }
                        await addDoc(itensCol, { nome, categoria }); 
                        showNotification('Novo item salvo!');
                    }
                    resetItemForm(); 
                } catch (error) {
                    console.error("Erro ao salvar item:", error);
                    showNotification("Erro ao salvar item.", true);
                }
            });
            
            // --- Formulário Produção (Criar/Editar) ---
            formProducao.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                const docId = prodEditId.value;
                const data = {
                    data: prodData.value,
                    colaborador: capitalizeWords(prodColaborador.value.trim()), 
                    proteina: prodProteina.value,
                    pesoKg: parseFloat(prodPeso.value) || null,
                    porcaoGramas: parseInt(prodPorcao.value) || null,
                    numPorcoes: parseInt(prodNumPorcoes.value)
                };
                
                if (!data.data || !data.colaborador || !data.proteina || isNaN(data.numPorcoes) || data.numPorcoes <= 0) {
                     return showNotification("Preencha Data, Colaborador, selecione um Item e Nº de Porções.", true);
                }
                
                try {
                    if (docId) {
                        await updateDoc(doc(producaoCol, docId), data);
                        showNotification('Lançamento atualizado!');
                    } else {
                        await addDoc(producaoCol, data);
                        showNotification('Lançamento salvo!');
                    }
                    resetProducaoForm();
                } catch (error) {
                    console.error("Erro ao salvar produção:", error);
                    showNotification("Erro ao salvar produção.", true);
                }
            });
            
            // --- Formulário Contagem (Criar/Editar) ---
            formContagem.addEventListener('submit', async (e) => {
                e.preventDefault();
                const docId = contEditId.value;
                const data = {
                    data: contData.value,
                    local: capitalizeWords(contLocal.value.trim()) || null, 
                    proteina: contProteina.value, 
                    unidade: capitalizeWords(contUnidade.value.trim()), 
                    quantidade: parseInt(contQuantidade.value)
                };

                if (!data.data || !data.proteina || !data.unidade || isNaN(data.quantidade) || data.quantidade < 0) {
                    return showNotification("Preencha Data, selecione um Item, Unidade e Quantidade.", true);
                }
                
                try {
                    if (docId) {
                        await updateDoc(doc(contagemCol, docId), data);
                        showNotification('Contagem atualizada!');
                    } else {
                        await addDoc(contagemCol, data);
                        showNotification('Contagem salva!');
                    }
                    resetContagemForm();
                    contFiltroDataInicio.value = data.data;
                    contFiltroDataFim.value = data.data;
                } catch (error) {
                    console.error("Erro ao salvar contagem:", error);
                    showNotification("Erro ao salvar contagem.", true);
                }
            });

            // --- Formulário Ficha Técnica (Criar/Editar) ---
            addIngredienteBtn.addEventListener('click', adicionarCampoIngrediente);

            formFicha.addEventListener('submit', async (e) => {
                e.preventDefault();
                const docId = fichaEditId.value;
                const data = {
                    nomePrato: capitalizeWords(fichaNomePrato.value.trim()),
                    tipoPrato: capitalizeWords(fichaTipoPrato.value.trim()),
                    colaborador: currentUserName // ATUALIZAÇÃO
                };

                if (!data.nomePrato || !data.tipoPrato) return;
                
                const ingredientes = [];
                const camposIngredientes = ingredientesContainer.querySelectorAll('.ingrediente-item');
                if (camposIngredientes.length === 0) return showNotification("Adicione pelo menos um ingrediente.", true);
                
                let formValido = true;
                camposIngredientes.forEach(item => {
                    const proteina = item.querySelector('.ficha-ingrediente-proteina').value;
                    const qtdPorcoes = parseInt(item.querySelector('.ficha-ingrediente-qtd').value);
                    if (!proteina || isNaN(qtdPorcoes) || qtdPorcoes <= 0) formValido = false;
                    ingredientes.push({ proteina, qtdPorcoes });
                });
                
                if (!formValido) return showNotification("Verifique os ingredientes.", true);
                
                const dataPayload = { ...data, ingredientes };

                try {
                    if (docId) {
                         if (fichasDB.some(f => f.nomePrato.toLowerCase() === data.nomePrato.toLowerCase() && f.id !== docId)) {
                            return showNotification("Este nome de prato já existe em outra ficha.", true);
                         }
                        await updateDoc(doc(fichasCol, docId), dataPayload);
                        showNotification('Ficha técnica atualizada!');
                    } else {
                         if (fichasDB.some(f => f.nomePrato.toLowerCase() === data.nomePrato.toLowerCase())) {
                            return showNotification("Este nome de prato já existe.", true);
                         }
                        await addDoc(fichasCol, dataPayload);
                        showNotification('Ficha técnica salva!');
                    }
                    resetFichaForm();
                } catch (error) {
                    console.error("Erro ao salvar ficha:", error);
                    showNotification("Erro ao salvar ficha técnica.", true);
                }
            });
            
            // --- Formulário Registrar Venda (Criar/Editar) ---
            formVenda.addEventListener('submit', async (e) => {
                e.preventDefault();
                const docId = vendaEditId.value;
                const dataBase = {
                    data: vendaData.value,
                    nomePrato: vendaPratoSelect.value, 
                    quantidade: parseInt(vendaQuantidade.value),
                    colaborador: currentUserName // ATUALIZAÇÃO
                };
                
                if (!dataBase.data || !dataBase.nomePrato || isNaN(dataBase.quantidade) || dataBase.quantidade <= 0) {
                    return showNotification("Preencha Data, Prato e Quantidade Vendida.", true);
                }
                
                // Lógica 'isSemanal' removida
                
                try {
                    if (docId) {
                        // Edição
                        await updateDoc(doc(vendasCol, docId), dataBase);
                        showNotification('Venda atualizada!');
                    } else {
                        // Criação (sempre diária/única)
                        await addDoc(vendasCol, dataBase);
                        showNotification('Venda registrada!');
                    }
                    resetVendaForm();
                } catch (error) {
                    console.error("Erro ao salvar venda:", error);
                    showNotification("Erro ao salvar venda.", true);
                }
            });

        });


        // --- MELHORIA: Funções de Edição e Reset ---

        // --- ABA ITENS ---
        window.editarItemItem = (docId, nome, categoria) => {
            if (userRole !== 'Proprietário') return;
            itemNome.value = nome;
            itemCategoria.value = categoria;
            itemEditId.value = docId; 
            
            itemSubmitButton.textContent = 'Salvar Alterações';
            itemSubmitButton.style.backgroundColor = 'var(--button-warning-bg)';
            cancelEditItemContainer.style.display = 'block';
            
            itemNome.focus();
            document.getElementById('itens').scrollIntoView({ behavior: 'smooth' });
        }
        function resetItemForm() {
            itemNome.value = '';
            itemCategoria.value = '';
            itemEditId.value = ''; 
            
            itemSubmitButton.textContent = 'Salvar Novo Item';
            itemSubmitButton.style.backgroundColor = 'var(--button-success-bg)';
            cancelEditItemContainer.style.display = 'none';
        }

        // --- ABA PRODUÇÃO ---
        window.editarItemProducao = (docId, data, colab, prot, peso, porcao, numPorcoes) => {
            if (userRole !== 'Proprietário') return;
            prodEditId.value = docId;
            prodData.value = data;
            prodColaborador.value = colab;
            prodProteina.value = prot;
            prodPeso.value = peso;
            prodPorcao.value = porcao;
            prodNumPorcoes.value = numPorcoes;
            
            prodSubmitButton.textContent = 'Salvar Alterações';
            prodSubmitButton.style.backgroundColor = 'var(--button-warning-bg)';
            cancelEditProdContainer.style.display = 'block';
            
            prodColaborador.focus();
            document.getElementById('producao').scrollIntoView({ behavior: 'smooth' });
        }
        function resetProducaoForm() {
            prodEditId.value = '';
            prodData.value = new Date().toISOString().split('T')[0];
            prodColaborador.value = '';
            prodProteina.value = '';
            prodPeso.value = '';
            prodPorcao.value = '';
            prodNumPorcoes.value = '';
            
            prodSubmitButton.textContent = 'Adicionar Lançamento';
            prodSubmitButton.style.backgroundColor = 'var(--button-success-bg)';
            cancelEditProdContainer.style.display = 'none';
        }

        // --- ABA CONTAGEM ---
         window.editarItemContagem = (docId, data, local, prot, qtd, unidade) => {
            if (userRole !== 'Proprietário') return;
            contEditId.value = docId;
            contData.value = data;
            contLocal.value = local;
            contProteina.value = prot;
            contQuantidade.value = qtd;
            contUnidade.value = unidade;

            contSubmitButton.textContent = 'Salvar Alterações';
            contSubmitButton.style.backgroundColor = 'var(--button-warning-bg)';
            cancelEditContContainer.style.display = 'block';
            
            contLocal.focus();
            document.getElementById('contagem').scrollIntoView({ behavior: 'smooth' });
        }
        function resetContagemForm() {
            contEditId.value = '';
            contData.value = new Date().toISOString().split('T')[0];
            contLocal.value = '';
            contProteina.value = '';
            contQuantidade.value = '';
            contUnidade.value = 'Porções';
            
            contSubmitButton.textContent = 'Salvar Contagem';
            contSubmitButton.style.backgroundColor = 'var(--button-success-bg)';
            cancelEditContContainer.style.display = 'none';
        }

        // --- ABA VENDAS (FICHA TÉCNICA) ---
        window.editarItemFicha = (docId) => {
            if (userRole !== 'Proprietário') return;
            const ficha = fichasDB.find(f => f.id === docId);
            if (!ficha) return;
            
            fichaEditId.value = docId;
            fichaNomePrato.value = ficha.nomePrato;
            fichaTipoPrato.value = ficha.tipoPrato;
            
            ingredientesContainer.innerHTML = '';
            (ficha.ingredientes || []).forEach(ing => {
                adicionarCampoIngrediente(ing.proteina, ing.qtdPorcoes);
            });
            
            fichaSubmitButton.textContent = 'Salvar Alterações';
            fichaSubmitButton.style.backgroundColor = 'var(--button-warning-bg)';
            cancelEditFichaContainer.style.display = 'block';
            
            fichaNomePrato.focus();
            document.getElementById('form-ficha').scrollIntoView({ behavior: 'smooth' });
        }
        function resetFichaForm() {
            fichaEditId.value = '';
            fichaNomePrato.value = '';
            fichaTipoPrato.value = '';
            
            ingredientesContainer.innerHTML = '';
            if (itensCarregados) { // Só adiciona se os itens já estiverem no cache
                adicionarCampoIngrediente(); 
            }
            
            fichaSubmitButton.textContent = 'Salvar Ficha Técnica';
            fichaSubmitButton.style.backgroundColor = 'var(--button-success-bg)';
            cancelEditFichaContainer.style.display = 'none';
        }
        
        // --- ABA VENDAS (REGISTRO DE VENDA) ---
        window.editarItemVenda = (docId, data, prato, qtd) => {
            if (userRole !== 'Proprietário') return;
            vendaEditId.value = docId;
            vendaData.value = data;
            vendaPratoSelect.value = prato;
            vendaQuantidade.value = qtd;
            // Lógica semanal removida
            
            vendaSubmitButton.textContent = 'Salvar Alterações';
            vendaSubmitButton.style.backgroundColor = 'var(--button-warning-bg)';
            cancelEditVendaContainer.style.display = 'block';
            
            vendaPratoSelect.focus();
            document.getElementById('form-venda').scrollIntoView({ behavior: 'smooth' });
        }
        function resetVendaForm() {
            vendaEditId.value = '';
            vendaData.value = new Date().toISOString().split('T')[0];
            vendaPratoSelect.value = '';
            vendaQuantidade.value = 1;
            // Lógica semanal removida
            
            vendaSubmitButton.textContent = 'Registrar Venda';
            vendaSubmitButton.style.backgroundColor = 'var(--button-success-bg)';
            cancelEditVendaContainer.style.display = 'none';
        }

        // --- Formulário Ficha Técnica ---
        
        function adicionarCampoIngrediente(proteina = '', qtdPorcoes = 1) {
            const div = document.createElement('div');
            div.className = 'ingrediente-item';
            
            const selectHTML = criarSelectProteinasHTML(); 
            div.innerHTML = `
                <div class="form-group">
                    <label>Item (Cadastrado)</label>
                    ${selectHTML}
                </div>
                <div class="form-group">
                    <label>Qtd. Porções</label>
                    <input type="number" class="ficha-ingrediente-qtd" value="${qtdPorcoes}" min="1" required>
                </div>
                <button type="button" onclick="removerCampoIngrediente(this)">X</button>
            `;
            
            ingredientesContainer.appendChild(div);
            const novoSelect = div.querySelector('.ficha-ingrediente-proteina');
            if (novoSelect) {
                novoSelect.value = proteina;
            }
        }
        
        
        // --- RELATÓRIO (Lógica local, usa dados do cache) ---
        
        // ATUALIZAÇÃO: Nova função auxiliar para somar contagens
        function somarContagens(listaContagens, dataAlvo, itemNome) {
            let total = 0;
            const contagensDoDia = listaContagens
                .filter(i => i.data === dataAlvo && 
                             i.proteina === itemNome &&
                             (i.unidade.toLowerCase() === 'porções' || i.unidade.toLowerCase() === 'porcoes'));
            
            contagensDoDia.forEach(contagem => {
                total += contagem.quantidade;
            });
            return total;
        }

        function calcularRelatorioBalanço(dataInicio, dataFim) {
            dataInicio = dataInicio || "1970-01-01";
            dataFim = dataFim || "2099-12-31";
            
            const relatorio = {}; 
            relatorioCache = []; 
            const todosOsItens = new Set(itensDB.map(i => i.nome));
            todosOsItens.forEach(item => {
                relatorio[item] = { inicial: 0, produzido: 0, vendido: 0, teorico: 0, fisico: null };
            });

            // 1. Estoque INICIAL (Contagem ANTES do início)
            // Encontra a data da última contagem ANTES do período
            const datasContagensIniciais = contagemDB
                .filter(i => i.data < dataInicio && (i.unidade.toLowerCase() === 'porções' || i.unidade.toLowerCase() === 'porcoes'))
                .map(i => i.data)
                .sort((a, b) => b.localeCompare(a)); // Ordena Z-A (mais recente primeiro)
            
            if (datasContagensIniciais.length > 0) {
                const ultimaDataInicial = datasContagensIniciais[0];
                console.log("Última data de contagem inicial:", ultimaDataInicial);
                // Soma todas as contagens dessa data para cada item
                todosOsItens.forEach(itemNome => {
                    relatorio[itemNome].inicial = somarContagens(contagemDB, ultimaDataInicial, itemNome);
                });
            }

            // 2. Produzido (Entradas DENTRO do período)
            producaoDB
                .filter(i => i.data >= dataInicio && i.data <= dataFim)
                .forEach(prod => {
                    if (relatorio[prod.proteina]) {
                        relatorio[prod.proteina].produzido += prod.numPorcoes;
                    }
                });

            // 3. Vendido (Saídas DENTRO do período)
            vendasDB
                .filter(i => i.data >= dataInicio && i.data <= dataFim)
                .forEach(venda => {
                    const ficha = fichasDB.find(f => f.nomePrato === venda.nomePrato);
                    if (ficha) {
                        (ficha.ingredientes || []).forEach(ing => {
                            if (relatorio[ing.proteina]) {
                                relatorio[ing.proteina].vendido += (ing.qtdPorcoes * venda.quantidade);
                            }
                        });
                    }
                });
                
            // 4. Estoque FINAL (Contagem DENTRO do período)
            // Encontra a data da última contagem DENTRO do período
            const datasContagensFinais = contagemDB
                .filter(i => i.data >= dataInicio && i.data <= dataFim && (i.unidade.toLowerCase() === 'porções' || i.unidade.toLowerCase() === 'porcoes'))
                .map(i => i.data)
                .sort((a, b) => b.localeCompare(a)); // Ordena Z-A (mais recente primeiro)

            if (datasContagensFinais.length > 0) {
                const ultimaDataFinal = datasContagensFinais[0];
                console.log("Última data de contagem final:", ultimaDataFinal);
                // Soma todas as contagens dessa data para cada item
                todosOsItens.forEach(itemNome => {
                    const totalFisico = somarContagens(contagemDB, ultimaDataFinal, itemNome);
                    // Só define o físico se houver de fato uma contagem para esse item
                    if (contagemDB.some(c => c.data === ultimaDataFinal && c.proteina === itemNome)) {
                         relatorio[itemNome].fisico = totalFisico;
                    }
                });
            }

            // 5. Renderiza a tabela
            listaRelatorio.innerHTML = '';
            const itensOrdenados = Object.keys(relatorio).sort();
            
            for (const item of itensOrdenados) {
                const dados = relatorio[item];
                // Só mostra se houve movimento ou contagem
                if (dados.inicial === 0 && dados.produzido === 0 && dados.vendido === 0 && dados.fisico === null) continue;
                
                dados.teorico = dados.inicial + dados.produzido - dados.vendido;
                let diferenca = null;
                let statusHtml = '<em>Sem contagem final</em>';
                let trClass = ''; // ATUALIZAÇÃO: Usa classe

                if (dados.fisico !== null) {
                    diferenca = dados.fisico - dados.teorico;
                    if (diferenca > 0) {
                        statusHtml = `<strong class="status-sobra">Sobra: ${diferenca}</strong>`;
                        trClass = 'row-sobra';
                    } else if (diferenca < 0) {
                        statusHtml = `<strong class="status-falta">Falta: ${Math.abs(diferenca)}</strong>`;
                        trClass = 'row-falta';
                    } else {
                        statusHtml = `<strong class="status-zerado">Zerado: 0</strong>`;
                    }
                }
                const tr = document.createElement('tr');
                tr.className = trClass; // ATUALIZAÇÃO: Define a classe
                tr.innerHTML = `
                    <td><strong>${item}</strong></td>
                    <td>${dados.inicial}</td>
                    <td>${dados.produzido}</td>
                    <td>${dados.vendido}</td>
                    <td>${dados.teorico}</td>
                    <td>${dados.fisico !== null ? dados.fisico : '-'}</td>
                    <td>${statusHtml}</td>
                `;
                listaRelatorio.appendChild(tr);
                relatorioCache.push({
                    item, ...dados,
                    status: (diferenca > 0 ? "Sobra" : (diferenca < 0 ? "Falta" : (diferenca === 0 ? "Zerado" : ""))),
                    valor: (diferenca !== null ? diferenca : "")
                });
            }
        }
        
        // --- FUNÇÕES UTILITÁRIAS ---
        
        function formatarData(dataISO) {
            if (!dataISO || !dataISO.includes('-')) return 'Data Inválida';
            const [ano, mes, dia] = dataISO.split('-').map(Number);
            const dataObj = new Date(Date.UTC(ano, mes - 1, dia)); 
            return dataObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        }

        // --- FUNÇÕES DE EXPORTAÇÃO E CÓPIA ---

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportarItens() {
            let csv = "Nome do Item;Categoria\n";
            itensDB.forEach(item => csv += [item.nome, item.categoria].join(';') + '\n');
            downloadCSV(csv, 'itens.csv');
        }

        function exportarProducao() {
            let csv = "Data;Colaborador;Item;Peso (kg);Porcao (g);Nº Porcoes\n";
            producaoDB.forEach(item => {
                csv += [
                    formatarData(item.data), item.colaborador, item.proteina,
                    item.pesoKg || '', item.porcaoGramas || '', item.numPorcoes
                ].join(';') + '\n';
            });
            downloadCSV(csv, 'producao.csv');
        }
        
        function exportarContagem() {
            let csv = "Data;Local;Item;Categoria;Quantidade;Unidade\n";
            const dataInicio = contFiltroDataInicio.value || '1970-01-01';
            const dataFim = contFiltroDataFim.value || '2099-12-31';
            contagemDB
                .filter(item => item.data >= dataInicio && item.data <= dataFim)
                .forEach(item => {
                    const itemInfo = itensDB.find(i => i.nome === item.proteina);
                    const categoria = (itemInfo && itemInfo.categoria) ? itemInfo.categoria : 'Sem Categoria';
                    csv += [
                        formatarData(item.data), item.local || '', item.proteina,
                        categoria, item.quantidade, item.unidade
                    ].join(';') + '\n';
                });
            downloadCSV(csv, `contagem_${dataInicio}_a_${dataFim}.csv`);
        }

        function exportarFichas() {
            let csv = "Colaborador;Nome Prato;Tipo Prato;Item (Ingrediente);Qtd. Porcoes\n";
            fichasDB.forEach(ficha => {
                (ficha.ingredientes || []).forEach(ing => {
                    csv += [ficha.colaborador || '', ficha.nomePrato, ficha.tipoPrato, ing.proteina, ing.qtdPorcoes].join(';') + '\n';
                });
            });
            downloadCSV(csv, 'fichas_tecnicas.csv');
        }

        function exportarVendas() {
            let csv = "Data;Colaboraor;Prato Vendido;Quantidade (Pratos)\n";
            vendasDB.forEach(venda => {
                csv += [formatarData(venda.data), venda.colaborador || '', venda.nomePrato, venda.quantidade].join(';') + '\n';
            });
            downloadCSV(csv, 'vendas.csv');
        }

        function exportarRelatorio() {
            let csv = "Item;Est. Inicial;Produzido;Vendido;Est. Teorico;Est. Fisico;Status;Valor\n";
            relatorioCache.forEach(item => {
                 csv += [
                    item.item, item.inicial, item.produzido, item.vendido,
                    item.teorico, item.fisico, item.status, item.valor
                ].join(';') + '\n';
            });
            const de = filtroDataInicio.value || 'inicio';
            const ate = filtroDataFim.value || 'fim';
            downloadCSV(csv, `relatorio_balanco_${de}_ate_${ate}.csv`);
        }
        
        function copiarContagemFormatada() {
            const dataInicio = contFiltroDataInicio.value;
            const dataFim = contFiltroDataFim.value;
            const contagensFiltradas = contagemDB.filter(item => item.data >= dataInicio && item.data <= dataFim);
            const contagensComCategoria = contagensFiltradas.map(item => {
                const itemInfo = itensDB.find(i => i.nome === item.proteina);
                const categoria = (itemInfo && itemInfo.categoria) ? itemInfo.categoria : 'Sem Categoria';
                return { ...item, categoria };
            });
            contagensComCategoria.sort((a, b) => {
                if (a.categoria !== b.categoria) return a.categoria.localeCompare(b.categoria);
                const localA = a.local || 'ZZZ';
                const localB = b.local || 'ZZZ';
                return localA.localeCompare(localB);
            });
            
            let texto = dataInicio === dataFim ? `*CONTAGEM (${formatarData(dataInicio)})*\n` : `*CONTAGEM (${formatarData(dataInicio)} a ${formatarData(dataFim)})*\n`;
            if (contagensComCategoria.length === 0) {
                texto += "\nNenhuma contagem registrada no período.";
            } else {
                let categoriaAtual = null, localAtual = null;
                contagensComCategoria.forEach(item => {
                    if (item.categoria !== categoriaAtual) {
                        texto += `\n*${item.categoria.toUpperCase()}*\n`;
                        categoriaAtual = item.categoria;
                        localAtual = null;
                    }
                    const local = item.local || "Outros";
                    if (local !== localAtual) {
                        texto += `_${local}_\n`;
                        localAtual = local;
                    }
                    texto += `- ${item.proteina}: *${item.quantidade} ${item.unidade}*\n`;
                });
            }
            copiarFallback(texto);
        }

        function copiarFallback(texto) {
            const textArea = document.createElement("textarea");
            textArea.value = texto;
            textArea.style.position = "fixed";
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) feedbackBotaoCopiado();
                else showNotification("Não foi possível copiar. Tente manualmente.", true);
            } catch (err) {
                console.error("Erro ao copiar (fallback):", err);
                showNotification("Não foi possível copiar. Tente manualmente.", true);
            }
            document.body.removeChild(textArea);
        }
        
        function feedbackBotaoCopiado() {
            const botao = copiarContagemBtn;
            if (!botao) return;
            const textoOriginal = "Copiar Contagem";
            botao.textContent = 'Copiado!';
            botao.classList.add('copied');
            setTimeout(() => {
                botao.textContent = textoOriginal;
                botao.classList.remove('copied');
            }, 2000);
        }

    </script>

</body>
</html>